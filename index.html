<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherWise - Yeovil Forecast & More</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db; 
            --secondary-color: #2ecc71; 
            --dark-color: #2c3e50;    
            --light-color: #f4f6f7;   
            --surface-color: #ffffff; 
            --accent-color: #5dade2;  
            --border-color: #e0e0e0;
            --text-color-base: #2c3e50; 
            --text-muted-base: #7f8c8d; 
            
            --border-radius-md: 8px;
            --border-radius-lg: 12px;

            --padding-xl: 40px;
            --padding-lg: 24px;
            --padding-md: 16px;
            --padding-sm: 12px;
            --padding-xs: 8px;

            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--light-color);
            color: var(--text-color-base);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--padding-md);
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: var(--padding-sm) 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000; 
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px; 
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            display: flex;
            align-items: center;
            transition: transform 0.3s ease; 
        }
        .logo:hover {
            transform: scale(1.05); 
        }
        .logo i {
            margin-right: 10px;
            font-size: 28px;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
        }
        .logo:hover i {
            transform: rotate(15deg) scale(1.1); 
        }

        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
        }
        nav ul li {
            margin-left: 20px;
        }
        nav ul li:last-child {
            margin-left: 15px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease, opacity 0.3s ease; 
            position: relative;
            padding: 5px 0; 
        }
        nav ul li a:hover {
            opacity: 0.8;
            color: var(--light-color); 
        }
        nav ul li a::after { 
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            background: var(--light-color); 
            opacity: 0.8;
            bottom: 0; 
            left: 50%;
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }
        nav ul li a:hover::after {
            width: 100%;
        }

        .unit-toggle-btn {
            background-color: rgba(255, 255, 255, 0.2); 
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 6px 12px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
            min-width: 50px;
            text-align: center;
        }
        .unit-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        .unit-toggle-btn:active {
            transform: scale(0.98);
        }

        /* Hero Section */
        .hero {
            padding: 120px 0 80px; 
            background-color: var(--dark-color); 
            background-size: cover;
            background-position: center center; 
            background-repeat: no-repeat;
            position: relative; 
            color: white;
            text-align: center;
            margin-top: 60px; 
            overflow: hidden; 
        }
        .hero::before { 
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(44, 62, 80, 0.5); 
            z-index: 0; 
        }
        .hero-content { 
            position: relative; 
            z-index: 1;    
            max-width: 700px; 
            margin: 0 auto;
        }
        .hero h1 {
            font-size: 38px; 
            margin-bottom: var(--padding-md); 
            animation: fadeIn 1s ease-in;
            font-weight: 600;
        }
        .hero p.tagline {
            font-size: 17px; 
            margin-bottom: var(--padding-lg);
            animation: fadeIn 1s ease-in 0.3s both;
            opacity: 0.9;
        }

        .search-form-wrapper {
            max-width: 600px; 
            margin: 0 auto;
            animation: fadeIn 1s ease-in 0.6s both;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: var(--padding-md); 
        }
        .search-form-container {
            display: flex;
            border-radius: 30px; 
            overflow: hidden; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
            width: 100%; 
            max-width: 500px; 
        }
        #locationInput {
            flex-grow: 1;
            padding: 15px 20px; 
            font-size: 16px; 
            border: 1px solid var(--border-color); 
            border-right: none; 
            border-top-left-radius: 30px;
            border-bottom-left-radius: 30px;
            outline: none;
            color: var(--text-color-base);
            background-color: var(--surface-color);
            transition: box-shadow 0.3s ease; 
        }
        #locationInput:focus {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }
        #searchButton { 
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 30px; 
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px; 
            border-top-right-radius: 30px;
            border-bottom-right-radius: 30px;
            transition: background-color 0.3s ease, transform 0.2s ease; 
            display: flex; 
            align-items: center;
            gap: 8px; 
        }
        #searchButton:hover {
            background-color: #27ae60; 
            transform: scale(1.02);
        }
        #searchButton:active {
            transform: scale(0.98);
        }
        #searchButton i { 
            transition: transform 0.3s ease;
        }
        #searchButton:hover i {
            transform: translateX(3px) scale(1.1); 
        }

        .search-input-error {
            color: #f1c40f; 
            font-size: 0.9rem; 
            margin-top: 8px; 
            height: 1.2em; 
            line-height: 1.2em;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-weight: 500;
            text-shadow: 0px 0px 1px rgba(0, 0, 0, 0.2); 
            width: 100%; 
            max-width: 500px; 
        }
        .search-input-error.visible {
            opacity: 1;
        }

        .geolocation-btn {
            background-color: transparent; 
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.7); 
            padding: 10px 20px; 
            border-radius: 25px; 
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem; 
            margin-top: var(--padding-md); 
            display: inline-flex; 
            align-items: center;
            gap: 8px; 
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        }
        .geolocation-btn:hover {
            background-color: rgba(255, 255, 255, 0.15); 
            transform: scale(1.03);
        }
        .geolocation-btn:active {
            transform: scale(0.99);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .geolocation-btn i {
            font-size: 1rem; 
        }
        .geolocation-btn:disabled {
            opacity: 0.7; 
            cursor: not-allowed;
        }
        .geolocation-btn .fa-spinner { 
            margin-right: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loader-container { 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--padding-xl) 0; 
            width: 100%;
            grid-column: 1 / -1; 
        }
        .loader {
            border: 6px solid var(--light-color); 
            border-top: 6px solid var(--primary-color); 
            border-radius: 50%;
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .weather-results-area {
            padding: var(--padding-xl) 0; 
            background-color: var(--light-color); 
            opacity: 0;
            transform: translateY(30px); 
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; 
            visibility: hidden; 
        }
        .weather-results-area.visible { 
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .section-title { 
            text-align: center;
            margin-bottom: var(--padding-lg); 
        }
        .section-title h2 {
            font-size: 32px; 
            color: var(--dark-color);
            position: relative;
            display: inline-block;
            padding-bottom: 10px;
            font-weight: 600;
        }
        .section-title h2::after { 
            content: '';
            position: absolute;
            width: 70px;
            height: 3px;
            background-color: var(--primary-color);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        #locationHeader {
             margin-bottom: var(--padding-lg); 
        }
        .section-subtitle { 
            font-size: 1.5rem; 
            color: var(--primary-color);
            text-align: center;
            margin-bottom: var(--padding-md);
            font-weight: 500; 
        }

        #currentWeatherCard {
            background-color: var(--surface-color);
            padding: var(--padding-lg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.1); 
            margin-bottom: var(--padding-xl); 
            display: grid;
            grid-template-columns: auto 1fr; 
            gap: var(--padding-lg);
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden; 
        }
        #currentWeatherCard:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(44, 62, 80, 0.15);
        }
        #currentWeatherCard .weather-icon-temp,
        #currentWeatherCard .current-details-grid {
            opacity: 0;
            transform: translateY(15px); 
            transition: opacity 0.5s ease-out 0.2s, transform 0.5s ease-out 0.2s; 
        }
        #currentWeatherCard.content-visible .weather-icon-temp,
        #currentWeatherCard.content-visible .current-details-grid {
            opacity: 1;
            transform: translateY(0);
        }
        #currentWeatherCard .weather-icon-temp {
            text-align: center;
        }
        #currentWeatherCard img.current-icon {
            width: 100px; 
            height: 100px; 
            margin-bottom: var(--padding-sm); 
            transition: transform 0.3s ease;
        }
        #currentWeatherCard:hover img.current-icon { 
            transform: scale(1.05);
        }
        #currentWeatherCard .current-temperature {
            font-size: 3.5rem; 
            font-weight: bold;
            color: var(--text-color-base);
            line-height: 1;
        }
        #currentWeatherCard .current-temperature sup {
            font-size: 1.5rem;
        }
        #currentWeatherCard .current-condition {
            font-size: 1.2rem; 
            color: var(--primary-color);
            font-weight: 500;
            text-transform: capitalize;
            margin-top: var(--padding-xs); 
        }
        .current-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: var(--padding-sm) var(--padding-md); 
        }
        .current-details-grid p {
            font-size: 0.95rem; 
            color: var(--text-muted-base); 
            background-color: var(--light-color); 
            padding: var(--padding-sm); 
            border-radius: var(--border-radius-md); 
            border: 1px solid var(--border-color); 
            transition: background-color 0.2s ease, box-shadow 0.2s ease; 
        }
        .current-details-grid p:hover { 
            background-color: var(--surface-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .current-details-grid p strong {
            color: var(--text-color-base);
            font-weight: 500;
            margin-right: 5px;
        }

        .hourly-forecast-section {
            margin-top: var(--padding-xl); 
            margin-bottom: var(--padding-xl); 
            background-color: var(--surface-color); 
            padding: var(--padding-lg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.08); 
        }
        .hourly-forecast-container {
            display: flex; 
            overflow-x: auto; 
            overflow-y: hidden; 
            padding: var(--padding-md) 0; 
            gap: var(--padding-md); 
            white-space: nowrap; 
            scrollbar-width: thin; 
            scrollbar-color: var(--primary-color) var(--light-color); 
        }
        .hourly-forecast-container::-webkit-scrollbar { height: 8px; } 
        .hourly-forecast-container::-webkit-scrollbar-track { background: var(--light-color); border-radius: 4px; }
        .hourly-forecast-container::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 4px; border: 2px solid var(--light-color); }
        .hourly-forecast-container::-webkit-scrollbar-thumb:hover { background-color: var(--accent-color); }
        .hourly-card {
            display: inline-flex; 
            flex-direction: column;
            align-items: center;
            justify-content: space-around; 
            min-width: 100px; 
            padding: var(--padding-md); 
            background-color: var(--light-color); 
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            text-align: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05); 
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, box-shadow 0.2s ease-out; 
        }
        .hourly-card.visible { opacity: 1; transform: scale(1); }
        .hourly-card:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 5px 12px rgba(0,0,0,0.1); } 
        .hourly-card .time { font-size: 0.9rem; font-weight: 600; color: var(--text-color-base); margin-bottom: var(--padding-xs); } 
        .hourly-card img.condition-icon { width: 40px; height: 40px; margin: var(--padding-xs) 0; } 
        .hourly-card .temp { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); margin-bottom: var(--padding-xs); } 
        .hourly-card .chance-of-rain { font-size: 0.75rem; color: var(--text-muted-base); } 
        .hourly-loader-placeholder { min-height: 150px; width: 100%; } 

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: var(--padding-md);
        }
        .forecast-card { 
            background-color: var(--surface-color);
            padding: var(--padding-md);
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.08); 
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            opacity: 0;
            transform: translateY(20px); 
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, box-shadow 0.3s ease; 
        }
        .forecast-card.visible { 
            opacity: 1;
            transform: translateY(0);
        }
        .forecast-card:hover {
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px rgba(44, 62, 80, 0.12);
        }
        .forecast-card .date { 
            font-size: 1rem; 
            font-weight: 600;
            color: var(--text-color-base); 
            margin-bottom: var(--padding-xs);
        }
        .forecast-card img.forecast-icon {
            width: 50px; 
            height: 50px; 
            margin: var(--padding-xs) auto;
            transition: transform 0.3s ease;
        }
        .forecast-card:hover img.forecast-icon { 
             transform: scale(1.1);
        }
        .forecast-card .temperature {
            font-size: 1.5rem; 
            font-weight: bold;
            color: var(--primary-color);
            margin: var(--padding-xs) 0;
        }
        .forecast-card .condition {
            font-size: 0.85rem; 
            color: var(--text-muted-base);
            text-transform: capitalize;
            margin-bottom: var(--padding-xs);
            flex-grow: 1;
        }
        .forecast-card .min-max {
            font-size: 0.8rem; 
            color: var(--text-muted-base);
        }

        .status-message-container {
            padding: var(--padding-xl) 0; 
            text-align: center;
            display: none; 
        }
        .status-message, .error-message { 
            font-size: 1.1rem;
            color: var(--text-color-base);
            opacity: 0.9;
            padding: var(--padding-lg); 
            background-color: var(--surface-color);
            border-radius: var(--border-radius-md);
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .error-message { 
            color: #e74c3c;
            background-color: #fdedec;
            border: 1px solid #f5b7b1; 
        }

        footer {
            background-color: var(--dark-color);
            color: #ccc; 
            padding: var(--padding-xl) 0 var(--padding-md); 
            margin-top: var(--padding-xl);
        }
        .footer-bottom { 
            text-align: center;
            padding-top: var(--padding-md); 
            border-top: 1px solid rgba(255, 255, 255, 0.1); 
            font-size: 0.9rem;
        }
        .footer-bottom a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color 0.3s ease; 
        }
        .footer-bottom a:hover { 
            text-decoration: underline;
            color: var(--primary-color); 
        }

        @media (max-width: 992px) {
            .forecast-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
            .hourly-card { min-width: 90px; padding: var(--padding-sm); } 
            .hourly-card .temp { font-size: 1.1rem; }
        }
        @media (max-width: 768px) {
            .header-container { flex-direction: column; height: auto; padding: var(--padding-sm) 0; }
            nav ul { margin-top: var(--padding-sm); justify-content: center; flex-wrap: wrap; }
            nav ul li { margin: 5px 10px; } 
            .hero { padding: 100px 0 60px; margin-top: 100px; } 
            .hero h1 { font-size: 32px; } 
            .hero p.tagline { font-size: 16px; } 
            .section-title h2 { font-size: 1.8rem; }
            .section-subtitle { font-size: 1.3rem; } 
            #currentWeatherCard { grid-template-columns: 1fr; text-align: center; }
            #currentWeatherCard .weather-icon-temp { margin-bottom: var(--padding-md); }
            .forecast-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } 
            .search-form-container { max-width: 100%; } 
        }
        @media (max-width: 480px) {
            nav ul li { margin-left: 15px; } 
            nav ul li:last-child { margin-left: 10px; }
            .unit-toggle-btn { padding: 5px 10px; font-size: 0.85rem; min-width: 45px;} 
            .logo { font-size: 22px; } .logo i { font-size: 24px; }
            .hero { padding: 80px 0 40px; margin-top: 90px; } 
            .hero h1 { font-size: 28px; } .hero p.tagline { font-size: 14px; }
            .search-form-wrapper { width: 95%; } 
            .search-form-container { flex-direction: column; border-radius: var(--border-radius-lg); max-width: none; }
            #locationInput { 
                border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; 
                text-align: center; 
                padding: 12px 15px; 
                border-right: 1px solid var(--border-color); 
            }
            #searchButton { 
                border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg); 
                padding: 12px 15px; 
                justify-content: center; 
            }
            .search-input-error { font-size: 0.85rem; }
            .current-details-grid { grid-template-columns: 1fr; } 
            .forecast-grid { grid-template-columns: 1fr; } 
            .hourly-card { min-width: 80px; padding: var(--padding-xs); } 
            .hourly-card .temp { font-size: 1rem;}
            .hourly-card img.condition-icon { width: 35px; height: 35px;}
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo"><i class="fas fa-cloud-sun"></i> WeatherWise</div>
            <nav>
                <ul>
                    <li><a href="#hero-section-target">Search</a></li>
                    <li><a href="#weather-results-target">Current Forecast</a></li>
                    <li><button id="unitToggleBtn" class="unit-toggle-btn" title="Switch temperature unit">°C</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="hero" id="hero-section-target" style="background-image: url('https://images.unsplash.com/photo-1428592953211-077101b2021b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');">
            <div class="hero-content">
                <h1>Weather Forecast</h1>
                <p class="tagline">Check the 10-day forecast for Yeovil below, or search for any other city.</p>
                <div class="search-form-wrapper">
                    <div class="search-form-container">
                        <input type="text" id="locationInput" placeholder="Enter city name (e.g., London, New York)">
                        <button id="searchButton"><i class="fas fa-search"></i> Search</button>
                    </div>
                    <div id="searchInputError" class="search-input-error"></div> 
                    <button id="geolocationBtn" class="geolocation-btn">
                        <i class="fas fa-map-marker-alt"></i> Use My Location
                    </button>
                </div>
            </div>
        </section>

        <section class="weather-results-area" id="weather-results-target">
            <div class="container">
                <div id="locationHeader" class="section-title"></div>
                <article id="currentWeatherCard"></article>
                <section id="hourlyForecastSection" class="hourly-forecast-section">
                    <h3 class="section-subtitle" id="hourlyForecastTitle">Today's Hourly Forecast</h3>
                    <div id="hourlyForecastContainer" class="hourly-forecast-container">
                        <div class="loader-container hourly-loader-placeholder"><div class="loader"></div></div>
                    </div>
                </section>
                <div class="section-title forecast-section-title">
                    <h2 id="forecastHeader">10-Day Forecast</h2>
                </div>
                <div id="forecastGrid" class="forecast-grid"></div>
            </div>
        </section>
        <div id="statusMessageContainer" class="status-message-container container"></div>
    </main>

    <footer>
        <div class="container footer-bottom">
            <p>© <span id="currentYear"></span> WeatherWise. Powered by <a href="https://www.weatherapi.com/" target="_blank" rel="noopener">WeatherAPI.com</a>.</p>
        </div>
    </footer>

    <script>
        const API_KEY = 'a3af77f2f03f42cbbe335101250306';
        const DEFAULT_LOCATION = 'Yeovil';
        const FORECAST_DAYS = 10;

        // DOM Elements
        const heroSection = document.querySelector('.hero');
        const locationInput = document.getElementById('locationInput');
        const searchButton = document.getElementById('searchButton');
        const searchInputError = document.getElementById('searchInputError');
        const unitToggleBtn = document.getElementById('unitToggleBtn');
        const geolocationBtn = document.getElementById('geolocationBtn');
        const weatherResultsArea = document.querySelector('.weather-results-area');
        const locationHeaderElement = document.getElementById('locationHeader');
        const currentWeatherCard = document.getElementById('currentWeatherCard');
        const hourlyForecastContainer = document.getElementById('hourlyForecastContainer');
        const forecastGrid = document.getElementById('forecastGrid');
        const statusMessageContainer = document.getElementById('statusMessageContainer');
        const currentYearSpan = document.getElementById('currentYear');

        let searchErrorTimeoutId = null;
        let lastSuccessfulWeatherData = null;
        let currentUnit = 'celsius';
        
        let isFetchingData = false; // Flag to prevent multiple simultaneous fetches

        // --- INITIALIZATION ---
        function initializeApp() {
            if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
            loadPreferredUnit();
            addEventListeners();
            fetchWeatherData(DEFAULT_LOCATION, true); 
        }

        function addEventListeners() {
            searchButton.addEventListener('click', handleSearch);
            locationInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
            locationInput.addEventListener('input', clearSearchInputError);
            unitToggleBtn.addEventListener('click', toggleUnit);
            geolocationBtn.addEventListener('click', handleGeolocation);
            window.addEventListener('scroll', () => requestAnimationFrame(handleParallax)); 
            handleParallax(); 
        }
        
        function clearSearchInputError() {
            if (searchInputError.classList.contains('visible')) {
                searchInputError.classList.remove('visible');
                searchInputError.textContent = ''; 
                if (searchErrorTimeoutId) clearTimeout(searchErrorTimeoutId);
            }
        }

        // --- PARALLAX EFFECT ---
        function handleParallax() {
            if (heroSection) {
                const scrollY = window.pageYOffset;
                heroSection.style.backgroundPositionY = `calc(50% + ${scrollY * 0.3}px)`; 
            }
        }

        // --- UNIT CONVERSION ---
        function loadPreferredUnit() {
            const savedUnit = localStorage.getItem('weatherAppUnit');
            currentUnit = savedUnit === 'fahrenheit' ? 'fahrenheit' : 'celsius';
            updateUnitToggleUI();
        }
        function toggleUnit() {
            currentUnit = currentUnit === 'celsius' ? 'fahrenheit' : 'celsius';
            localStorage.setItem('weatherAppUnit', currentUnit);
            updateUnitToggleUI();
            if (lastSuccessfulWeatherData) displayAllWeatherData(lastSuccessfulWeatherData); 
        }
        function updateUnitToggleUI() {
            unitToggleBtn.textContent = currentUnit === 'celsius' ? '°C' : '°F';
        }
        function getTemp(c, f, unitSymbol = true) {
            const symbol = unitSymbol ? (currentUnit === 'celsius' ? '°C' : '°F') : '';
            if (currentUnit === 'fahrenheit') return f !== undefined ? `${Math.round(f)}${symbol}` : 'N/A';
            return c !== undefined ? `${Math.round(c)}${symbol}` : 'N/A';
        }

        // --- GEOLOCATION ---
        async function handleGeolocation() {
            if (isFetchingData) return;
            if (!navigator.geolocation) {
                showTemporaryError("Geolocation not supported.", 3000); return;
            }
            geolocationBtn.disabled = true;
            geolocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finding...';
            clearSearchInputError();
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true, timeout: 10000, maximumAge: 0 
                    });
                });
                locationInput.value = ''; 
                fetchWeatherData(`${position.coords.latitude},${position.coords.longitude}`);
            } catch (error) {
                let msg = "Location error: ";
                switch (error.code) {
                    case error.PERMISSION_DENIED: msg += "Permission denied."; break;
                    case error.POSITION_UNAVAILABLE: msg += "Location unavailable."; break;
                    case error.TIMEOUT: msg += "Request timed out."; break;
                    default: msg += "Unknown error. " + (error.message || ''); break;
                }
                showTemporaryError(msg, 4000);
                console.error("Geolocation Error:", error);
                 // If geolocation fails, and we had previous data, ensure it's still shown
                if (lastSuccessfulWeatherData) {
                    weatherResultsArea.classList.add('visible');
                }
            } finally {
                geolocationBtn.disabled = false;
                geolocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use My Location';
            }
        }
        
        // --- UI UPDATES & ERROR DISPLAY ---
        function showTemporaryError(message, duration = 3000) { 
            searchInputError.textContent = message;
            searchInputError.classList.add('visible');
            if (searchErrorTimeoutId) clearTimeout(searchErrorTimeoutId);
            searchErrorTimeoutId = setTimeout(() => {
                searchInputError.classList.remove('visible');
                 setTimeout(() => { searchInputError.textContent = ''; }, 300); 
            }, duration);
        }

        function showGeneralError(message) { // For critical errors where no data can be shown
            statusMessageContainer.innerHTML = `<div class="error-message">${message}</div>`;
            statusMessageContainer.style.display = 'block';
            currentWeatherCard.innerHTML = ''; // Clear previous data on critical error
            hourlyForecastContainer.innerHTML = '';
            forecastGrid.innerHTML = '';
            locationHeaderElement.innerHTML = '';
            weatherResultsArea.classList.remove('visible');
            lastSuccessfulWeatherData = null; // No valid data to show
        }

        function clearGeneralError() {
            statusMessageContainer.innerHTML = '';
            statusMessageContainer.style.display = 'none';
        }

        function showLoaders() {
            // Only show loaders if there's no previous data or if it's an initial load
            // This prevents loaders from covering existing data during a failed new search
            if (!lastSuccessfulWeatherData || weatherResultsArea.classList.contains('visible') === false) {
                currentWeatherCard.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
                hourlyForecastContainer.innerHTML = `<div class="loader-container hourly-loader-placeholder"><div class="loader"></div></div>`;
                forecastGrid.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
                locationHeaderElement.innerHTML = ''; // Clear location too
                weatherResultsArea.classList.remove('visible');
            }
        }


        // --- API FETCHING ---
        async function handleSearch() {
            if (isFetchingData) return;
            const query = locationInput.value.trim();
            if (!query) {
                showTemporaryError("Please enter a city name."); return;
            }
            clearSearchInputError();
            fetchWeatherData(query);
        }

        async function fetchWeatherData(locationQuery, isInitialLoad = false) {
            if (isFetchingData && !isInitialLoad) return; // Prevent multiple fetches unless initial
            isFetchingData = true;
            
            if (isInitialLoad || !lastSuccessfulWeatherData) { // Show loaders for initial load or if no prior data
                showLoaders();
            }
            clearGeneralError();   

            const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${encodeURIComponent(locationQuery)}&days=${FORECAST_DAYS}&aqi=no&alerts=no`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    let errorMsg = `Error: ${response.status}`;
                    if (errorData && errorData.error && errorData.error.message) {
                        errorMsg = errorData.error.message;
                    } else if (response.status === 400) {
                        errorMsg = "Invalid location or API request. Please check the city name.";
                    } else if (response.status === 401 || response.status === 403) {
                        errorMsg = "API key error. Please contact support.";
                    }
                    throw new Error(errorMsg); 
                }
                const data = await response.json();
                
                lastSuccessfulWeatherData = data; 
                displayAllWeatherData(data);      
                
                if (!isInitialLoad) { 
                    document.getElementById('weather-results-target').scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error('Fetch Weather Error:', error);
                showTemporaryError(error.message || "Could not fetch weather data.", 4000);
                
                // If an error occurs, and we had previous data, ensure the results area is still visible.
                // The loaders might have hidden it.
                if (lastSuccessfulWeatherData) {
                    weatherResultsArea.classList.add('visible');
                     // Re-display the last good data to remove any loaders that might have appeared
                    displayAllWeatherData(lastSuccessfulWeatherData);
                } else if (isInitialLoad) {
                    // If it's an initial load error, show a general error and clear potential loaders.
                    showGeneralError(`Could not load weather for ${locationQuery}. ${error.message}`);
                }
            } finally {
                isFetchingData = false;
            }
        }

        // --- DATA DISPLAY ---
        function displayAllWeatherData(data) {
            // Clear any existing general error messages first
            clearGeneralError();
            
            displayCurrentWeather(data.location, data.current);
            displayHourlyForecast(data.forecast.forecastday[0].hour); 
            displayDailyForecast(data.forecast.forecastday);
            weatherResultsArea.classList.add('visible'); // Ensure area is visible
        }

        function displayCurrentWeather(location, current) {
            locationHeaderElement.innerHTML = `<h2>${location.name}, ${location.country}</h2>`;
            
            const feelsLikeTempC = current.feelslike_c;
            const feelsLikeTempF = current.feelslike_f;

            currentWeatherCard.innerHTML = `
                <div class="weather-icon-temp">
                    <img src="https:${current.condition.icon}" alt="${current.condition.text}" class="current-icon">
                    <p class="current-temperature">${getTemp(current.temp_c, current.temp_f)}</p>
                    <p class="current-condition">${current.condition.text}</p>
                </div>
                <div class="current-details-grid">
                    <p><strong>Feels Like:</strong> ${getTemp(feelsLikeTempC, feelsLikeTempF)}</p>
                    <p><strong>Humidity:</strong> ${current.humidity}%</p>
                    <p><strong>Wind:</strong> ${Math.round(current.wind_kph)} kph / ${Math.round(current.wind_mph)} mph ${current.wind_dir}</p>
                    <p><strong>Pressure:</strong> ${current.pressure_mb} mb</p>
                    <p><strong>Visibility:</strong> ${current.vis_km} km / ${current.vis_miles} miles</p>
                    <p><strong>UV Index:</strong> ${current.uv}</p>
                    <p><strong>Cloud Cover:</strong> ${current.cloud}%</p>
                    <p><strong>Last Updated:</strong> ${new Date(current.last_updated_epoch * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                </div>
            `;
            setTimeout(() => currentWeatherCard.classList.add('content-visible'), 50);
        }

        function displayHourlyForecast(hourlyData) {
            hourlyForecastContainer.innerHTML = ''; 
            const now = new Date();
            const currentHour = now.getHours();

            let hasFutureHours = false;
            hourlyData.forEach((hour, index) => {
                const hourDate = new Date(hour.time_epoch * 1000);
                if (hourDate.getHours() >= currentHour) {
                    hasFutureHours = true;
                    const card = document.createElement('div');
                    card.className = 'hourly-card';
                    card.innerHTML = `
                        <p class="time">${hourDate.toLocaleTimeString([], { hour: 'numeric', hour12: true })}</p>
                        <img src="https:${hour.condition.icon}" alt="${hour.condition.text}" class="condition-icon">
                        <p class="temp">${getTemp(hour.temp_c, hour.temp_f)}</p>
                        <p class="chance-of-rain"><i class="fas fa-tint"></i> ${hour.chance_of_rain}%</p>
                    `;
                    hourlyForecastContainer.appendChild(card);
                    setTimeout(() => card.classList.add('visible'), index * 50);
                }
            });
             if (!hasFutureHours) { 
                hourlyForecastContainer.innerHTML = `<p style="padding: 10px; text-align:center; width:100%;">No more hourly forecast for today.</p>`;
            }
        }

        function displayDailyForecast(forecastDays) {
            forecastGrid.innerHTML = ''; 
            forecastDays.forEach((dayData, index) => {
                const day = dayData.day;
                const card = document.createElement('div');
                card.className = 'forecast-card';
                const date = new Date(dayData.date_epoch * 1000);
                const dayName = index === 0 ? "Today" : date.toLocaleDateString([], { weekday: 'short' });
                
                card.innerHTML = `
                    <p class="date">${dayName} <span style="font-weight:normal; font-size:0.8em">(${date.toLocaleDateString([], {month:'short', day:'numeric'})})</span></p>
                    <img src="https:${day.condition.icon}" alt="${day.condition.text}" class="forecast-icon">
                    <p class="temperature">${getTemp(day.avgtemp_c, day.avgtemp_f)}</p>
                    <p class="condition">${day.condition.text}</p>
                    <p class="min-max">Max: ${getTemp(day.maxtemp_c, day.maxtemp_f, false)} / Min: ${getTemp(day.mintemp_c, day.mintemp_f, false)}</p>
                    <p class="chance-of-rain" style="font-size: 0.75rem; margin-top: 4px;"><i class="fas fa-tint"></i> Rain: ${day.daily_chance_of_rain}%</p>
                `;
                forecastGrid.appendChild(card);
                setTimeout(() => card.classList.add('visible'), index * 80);
            });
        }
        // --- RUN APP ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>