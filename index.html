<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation Test on Vercel</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; text-align: center; }
        h1 { color: #333; }
        button {
            padding: 12px 25px;
            font-size: 18px;
            background-color: dodgerblue;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 0;
        }
        button:disabled {
            background-color: lightgray;
            cursor: not-allowed;
        }
        #locationStatus {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #fff;
            min-height: 50px;
        }
        .success { color: green; border-color: green; }
        .error { color: red; border-color: red; }
        pre {
            background-color: #eee; padding: 10px;
            border-radius: 5px; white-space: pre-wrap;
            word-wrap: break-word; text-align: left;
            max-height: 200px; overflow-y: auto;
        }
    </style>
</head>
<body>

    <h1>Testing Geolocation API on Vercel</h1>
    <p>Click the button below. Your browser should ask for location permission.</p>

    <button id="getLocationBtn">Get My Location</button>

    <div id="locationStatus">
        <p>Click the button to get your location.</p>
    </div>

    <div id="coordsDisplay" style="display:none;">
        <h2>Coordinates:</h2>
        <pre></pre>
    </div>
    
    <div id="weatherApiResponse" style="display:none;">
        <h2>Weather API Response (Using Geolocation):</h2>
        <pre></pre>
    </div>

    <script>
        const getLocationBtn = document.getElementById('getLocationBtn');
        const locationStatusElement = document.getElementById('locationStatus');
        const coordsDisplayElement = document.getElementById('coordsDisplay');
        const coordsPre = coordsDisplayElement.querySelector('pre');
        const weatherApiResponseElement = document.getElementById('weatherApiResponse');
        const weatherApiPre = weatherApiResponseElement.querySelector('pre');

        // Use the same API key from your app for a consistent test
        const MY_API_KEY = 'a3af77f2f03f42cbbe335101250306'; 

        if (getLocationBtn) {
            getLocationBtn.addEventListener('click', function() {
                locationStatusElement.innerHTML = "<p>Requesting location permission...</p>";
                coordsDisplayElement.style.display = 'none';
                weatherApiResponseElement.style.display = 'none';
                getLocationBtn.disabled = true;
                getLocationBtn.textContent = 'Fetching...';

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async function(position) { // Made success callback async
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;

                            locationStatusElement.innerHTML = '<p class="success">Location permission granted! Fetching weather...</p>';
                            coordsPre.textContent = `Latitude: ${lat}\nLongitude: ${lon}\nAccuracy: ${position.coords.accuracy} meters`;
                            coordsDisplayElement.style.display = 'block';
                            console.log("Coordinates obtained:", lat, lon);

                            // Now try to fetch weather with these coordinates
                            const weatherApiUrl = `https://api.weatherapi.com/v1/current.json?q=${lat},${lon}&key=${MY_API_KEY}`;
                            console.log("Fetching weather from:", weatherApiUrl);
                            weatherApiPre.textContent = "Fetching weather data with coordinates...";
                            weatherApiResponseElement.style.display = 'block';

                            try {
                                const weatherResponse = await fetch(weatherApiUrl);
                                const weatherText = await weatherResponse.text(); // Get raw text

                                if (!weatherResponse.ok) {
                                    let weatherErrorData;
                                    try {
                                        weatherErrorData = JSON.parse(weatherText);
                                        throw new Error(`Weather API Error ${weatherResponse.status}: ${weatherErrorData.error ? weatherErrorData.error.message : weatherResponse.statusText}`);
                                    } catch (e) {
                                        throw new Error(`Weather HTTP Error ${weatherResponse.status}: ${weatherResponse.statusText}. Raw: ${weatherText}`);
                                    }
                                }
                                const weatherData = JSON.parse(weatherText);
                                console.log("Weather data from Geolocation:", weatherData);
                                weatherApiPre.textContent = JSON.stringify(weatherData, null, 2);
                                locationStatusElement.innerHTML += '<p class="success">Weather data fetched successfully using your location!</p>';

                            } catch (error) {
                                console.error("Error fetching weather with Geolocation:", error);
                                weatherApiPre.textContent = `Error fetching weather: ${error.message}`;
                                locationStatusElement.innerHTML += `<p class="error">Could not fetch weather data: ${error.message}</p>`;
                            } finally {
                                getLocationBtn.disabled = false;
                                getLocationBtn.textContent = 'Get My Location';
                            }
                        },
                        function(error) {
                            let message = "Error getting location: ";
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    message += "User denied the request for Geolocation.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    message += "Location information is unavailable.";
                                    break;
                                case error.TIMEOUT:
                                    message += "The request to get user location timed out.";
                                    break;
                                case error.UNKNOWN_ERROR:
                                    message += "An unknown error occurred.";
                                    break;
                            }
                            locationStatusElement.innerHTML = `<p class="error">${message}</p>`;
                            console.error("Geolocation Error Details:", error);
                            getLocationBtn.disabled = false;
                            getLocationBtn.textContent = 'Get My Location';
                        },
                        { // Options
                            enableHighAccuracy: false, // true can be slower but more accurate
                            timeout: 10000,        // 10 seconds
                            maximumAge: 0          // Force fresh location
                        }
                    );
                } else {
                    locationStatusElement.innerHTML = "<p class='error'>Geolocation is not supported by this browser.</p>";
                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'Get My Location';
                }
            });
        } else {
            locationStatusElement.innerHTML = "<p class='error'>Button not found!</p>";
        }
    </script>

</body>
</html>
