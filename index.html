<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherWise - Fresh Start</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Basic Reset & Root Variables */
        :root {
            --primary-color: #3498db; --secondary-color: #2ecc71; --dark-color: #2c3e50;
            --light-color: #f4f6f7;   --surface-color: #ffffff; --accent-color: #5dade2;
            --border-color: #e0e0e0; --text-color-base: #2c3e50; --text-muted-base: #7f8c8d;
            --border-radius-md: 8px; --border-radius-lg: 12px; --padding-lg: 24px;
            --padding-md: 16px; --padding-sm: 12px; --font-family: 'Segoe UI', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-family); }
        html { scroll-behavior: smooth; }
        body { background-color: var(--light-color); color: var(--text-color-base); line-height: 1.6; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 var(--padding-md); }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white;
            padding: var(--padding-sm) 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: fixed;
            width: 100%; top: 0; z-index: 1000;
        }
        .header-container { display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; }
        .logo i { margin-right: 8px; font-size: 26px; }
        nav ul { display: flex; list-style: none; align-items: center; }
        nav ul li { margin-left: 15px; }
        nav ul li a { color: white; text-decoration: none; font-weight: 500; padding: 5px 0; position: relative; }
        nav ul li a:hover { opacity: 0.8; }
        .unit-toggle-btn {
            background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4);
            padding: 5px 10px; border-radius: var(--border-radius-md); cursor: pointer; font-weight: 600;
            font-size: 0.85rem; transition: background-color 0.2s ease; min-width: 45px; text-align: center;
        }
        .unit-toggle-btn:hover { background-color: rgba(255,255,255,0.3); }

        /* Hero Section */
        .hero {
            padding: 140px 0 70px; margin-top: 60px; /* Adjusted for fixed header */
            background-image: url('https://images.unsplash.com/photo-1534790566855-4cb788d389ec?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80');
            background-size: cover; background-position: center 30%; color: white; text-align: center; position: relative;
        }
        .hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.4); z-index: 0;}
        .hero-content { position: relative; z-index: 1; max-width: 600px; margin: 0 auto; }
        .hero h1 { font-size: 2.5rem; margin-bottom: var(--padding-sm); font-weight: 600; }
        .hero p.tagline { font-size: 1.1rem; margin-bottom: var(--padding-lg); opacity: 0.9; }
        .search-form-wrapper { display: flex; flex-direction: column; align-items: center; gap: var(--padding-sm); }
        .search-form-container { display: flex; border-radius: 30px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 100%; max-width: 480px; }
        #locationInput { flex-grow: 1; padding: 12px 18px; font-size: 1rem; border: none; outline: none; color: var(--text-color-base); background-color: var(--surface-color); border-top-left-radius: 30px; border-bottom-left-radius: 30px;}
        #searchButton { background-color: var(--secondary-color); color: white; padding: 12px 25px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; border-top-right-radius: 30px; border-bottom-right-radius: 30px; display: flex; align-items: center; gap: 5px;}
        #searchButton:hover { background-color: #27ae60; }
        .search-input-error { color: #f1c40f; font-size: 0.85rem; height: 1.1em; line-height: 1.1em; opacity: 0; transition: opacity 0.3s ease; font-weight: 500; }
        .search-input-error.visible { opacity: 1; }
        .geolocation-btn {
            background-color: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.6);
            padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.2s ease;
        }
        .geolocation-btn:hover { background-color: rgba(255,255,255,0.2); }
        .geolocation-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .geolocation-btn .fa-spinner { margin-right: 5px; }

        /* Loader */
        .loader-container { display: flex; justify-content: center; align-items: center; padding: var(--padding-xl) 0; width: 100%; grid-column: 1 / -1; }
        .loader { border: 5px solid var(--light-color); border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Results Area */
        .weather-results-area { padding: var(--padding-lg) 0; opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease; visibility: hidden;}
        .weather-results-area.visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .section-title h2, .section-subtitle { text-align: center; color: var(--dark-color); margin-bottom: var(--padding-md); font-weight: 600;}
        .section-title h2 { font-size: 1.8rem; } .section-subtitle { font-size: 1.4rem; color: var(--primary-color); }
        
        #currentWeatherCard {
            background-color: var(--surface-color); padding: var(--padding-lg); border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: var(--padding-lg); display: grid;
            grid-template-columns: auto 1fr; gap: var(--padding-lg); align-items: center; overflow: hidden;
        }
        #currentWeatherCard .weather-icon-temp, #currentWeatherCard .current-details-grid { opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease-out 0.1s, transform 0.4s ease-out 0.1s; }
        #currentWeatherCard.content-visible .weather-icon-temp, #currentWeatherCard.content-visible .current-details-grid { opacity: 1; transform: translateY(0); }
        #currentWeatherCard .weather-icon-temp { text-align: center;}
        #currentWeatherCard img.current-icon { width: 80px; height: 80px; margin-bottom: var(--padding-xs); }
        #currentWeatherCard .current-temperature { font-size: 2.8rem; font-weight: bold; }
        #currentWeatherCard .current-condition { font-size: 1.1rem; color: var(--primary-color); text-transform: capitalize; }
        .current-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: var(--padding-sm); }
        .current-details-grid p { font-size: 0.9rem; color: var(--text-muted-base); padding: var(--padding-xs) 0;}
        .current-details-grid p strong { color: var(--text-color-base); }

        .hourly-forecast-section { margin: var(--padding-lg) 0; }
        .hourly-forecast-container { display: flex; overflow-x: auto; padding-bottom: var(--padding-sm); gap: var(--padding-md); scrollbar-width: thin; scrollbar-color: var(--accent-color) var(--light-color); }
        .hourly-forecast-container::-webkit-scrollbar { height: 6px; }
        .hourly-forecast-container::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 3px; }
        .hourly-card {
            display: flex; flex-direction: column; align-items: center; min-width: 85px; padding: var(--padding-sm);
            background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md);
            opacity: 0; transform: scale(0.9); transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .hourly-card.visible { opacity: 1; transform: scale(1); }
        .hourly-card .time { font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; }
        .hourly-card img.condition-icon { width: 35px; height: 35px; margin: 4px 0; }
        .hourly-card .temp { font-size: 1rem; font-weight: bold; color: var(--primary-color); }
        .hourly-card .chance-of-rain { font-size: 0.7rem; color: var(--text-muted-base); margin-top: 4px; }
        .hourly-loader-placeholder { min-height: 120px; }

        .forecast-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--padding-md); }
        .forecast-card {
            background-color: var(--surface-color); padding: var(--padding-md); border-radius: var(--border-radius-lg);
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.07); display: flex; flex-direction: column;
            opacity: 0; transform: translateY(15px); transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .forecast-card.visible { opacity: 1; transform: translateY(0); }
        .forecast-card .date { font-size: 0.95rem; font-weight: 600; margin-bottom: var(--padding-xs); }
        .forecast-card img.forecast-icon { width: 45px; height: 45px; margin: var(--padding-xs) auto; }
        .forecast-card .temperature { font-size: 1.4rem; font-weight: bold; color: var(--primary-color); margin: var(--padding-xs) 0; }
        .forecast-card .condition { font-size: 0.8rem; color: var(--text-muted-base); text-transform: capitalize; flex-grow: 1; margin-bottom: var(--padding-xs); }
        .forecast-card .min-max { font-size: 0.75rem; color: var(--text-muted-base); }
        
        .status-message-container { padding: var(--padding-lg) 0; text-align: center; display: none; }
        .error-message { color: #e74c3c; background-color: #fdedec; border: 1px solid #f5c6cb; padding: var(--padding-md); border-radius: var(--border-radius-md); }

        footer { background-color: var(--dark-color); color: #ccc; padding: var(--padding-lg) 0 var(--padding-md); margin-top: var(--padding-xl); text-align: center;}
        .footer-bottom p { font-size: 0.9rem; }
        .footer-bottom a { color: var(--accent-color); text-decoration: none; }
        .footer-bottom a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; } .hero p.tagline { font-size: 1rem; }
            .search-form-container { max-width: 100%; }
            #currentWeatherCard { grid-template-columns: 1fr; text-align: center; }
            #currentWeatherCard .weather-icon-temp { margin-bottom: var(--padding-md); }
            .forecast-grid { grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
        }
        @media (max-width: 480px) {
            nav ul li { margin-left: 10px; }
            .unit-toggle-btn { padding: 4px 8px; font-size: 0.8rem; min-width: 40px;}
            .hero { padding: 120px 0 50px; }
            .search-form-container { flex-direction: column; border-radius: var(--border-radius-lg); }
            #locationInput { border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; text-align: center; border-right: 1px solid var(--border-color); }
            #searchButton { border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg); justify-content: center; }
            .hourly-card { min-width: 75px; }
            .forecast-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo"><i class="fas fa-cloud-sun"></i> WeatherWise</div>
            <nav>
                <ul>
                    <li><a href="#hero-section-target">Search</a></li>
                    <li><a href="#weather-results-target">Forecast</a></li>
                    <li><button id="unitToggleBtn" class="unit-toggle-btn" title="Switch temperature unit">°C</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="hero" id="hero-section-target">
            <div class="hero-content">
                <h1>Weather Forecast</h1>
                <p class="tagline">Live weather updates for any city.</p>
                <div class="search-form-wrapper">
                    <div class="search-form-container">
                        <input type="text" id="locationInput" placeholder="Enter city name">
                        <button id="searchButton"><i class="fas fa-search"></i> Search</button>
                    </div>
                    <div id="searchInputError" class="search-input-error"></div> 
                    <button id="geolocationBtn" class="geolocation-btn">
                        <i class="fas fa-map-marker-alt"></i> Use My Location
                    </button>
                </div>
            </div>
        </section>

        <section class="weather-results-area" id="weather-results-target">
            <div class="container">
                <div id="locationHeader" class="section-title"></div>
                <article id="currentWeatherCard"></article>
                <section id="hourlyForecastSection" class="hourly-forecast-section">
                    <h3 class="section-subtitle" id="hourlyForecastTitle">Today's Hourly Forecast</h3>
                    <div id="hourlyForecastContainer" class="hourly-forecast-container">
                        <div class="loader-container hourly-loader-placeholder"><div class="loader"></div></div>
                    </div>
                </section>
                <div class="section-title"> 
                    <h2 id="forecastHeader">10-Day Forecast</h2>
                </div>
                <div id="forecastGrid" class="forecast-grid"></div>
            </div>
        </section>
        <div id="statusMessageContainer" class="status-message-container container"></div>
    </main>

    <footer>
        <div class="container footer-bottom">
            <p>© <span id="currentYear"></span> WeatherWise. Powered by <a href="https://www.weatherapi.com/" target="_blank" rel="noopener">WeatherAPI.com</a>.</p>
        </div>
    </footer>

    <script>
        const API_KEY = 'a3af77f2f03f42cbbe335101250306';
        const DEFAULT_LOCATION = 'Yeovil';
        const FORECAST_DAYS = 10;

        // DOM Elements
        const heroSection = document.querySelector('.hero');
        const locationInput = document.getElementById('locationInput');
        const searchButton = document.getElementById('searchButton');
        const searchInputError = document.getElementById('searchInputError');
        const unitToggleBtn = document.getElementById('unitToggleBtn');
        const geolocationBtn = document.getElementById('geolocationBtn');
        const weatherResultsArea = document.querySelector('.weather-results-area');
        const locationHeaderElement = document.getElementById('locationHeader');
        const forecastHeaderElement = document.getElementById('forecastHeader');
        const hourlyForecastTitleElement = document.getElementById('hourlyForecastTitle');
        const currentWeatherCard = document.getElementById('currentWeatherCard');
        const hourlyForecastContainer = document.getElementById('hourlyForecastContainer');
        const forecastGrid = document.getElementById('forecastGrid');
        const statusMessageContainer = document.getElementById('statusMessageContainer');
        const currentYearSpan = document.getElementById('currentYear');

        let searchErrorTimeoutId = null;
        let lastSuccessfulWeatherData = null;
        let currentUnit = 'celsius';

        // --- INITIALIZATION ---
        function initializeApp() {
            if (currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
            loadPreferredUnit();
            addEventListeners();
            fetchWeatherData(DEFAULT_LOCATION, true); // Initial fetch for default location
        }

        function addEventListeners() {
            searchButton.addEventListener('click', handleSearch);
            locationInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
            locationInput.addEventListener('input', clearSearchInputError);
            unitToggleBtn.addEventListener('click', toggleUnit);
            geolocationBtn.addEventListener('click', handleGeolocation);
            window.addEventListener('scroll', () => requestAnimationFrame(handleParallax));
            handleParallax(); // Initial call
        }
        
        function clearSearchInputError() {
            if (searchInputError.classList.contains('visible')) {
                searchInputError.classList.remove('visible');
                if (searchErrorTimeoutId) clearTimeout(searchErrorTimeoutId);
            }
        }

        // --- PARALLAX ---
        function handleParallax() {
            if (heroSection) {
                heroSection.style.backgroundPositionY = window.pageYOffset * 0.4 + 'px';
            }
        }

        // --- UNIT CONVERSION ---
        function loadPreferredUnit() {
            const savedUnit = localStorage.getItem('weatherAppUnit');
            currentUnit = savedUnit === 'fahrenheit' ? 'fahrenheit' : 'celsius';
            updateUnitToggleUI();
        }
        function toggleUnit() {
            currentUnit = currentUnit === 'celsius' ? 'fahrenheit' : 'celsius';
            localStorage.setItem('weatherAppUnit', currentUnit);
            updateUnitToggleUI();
            if (lastSuccessfulWeatherData) displayAllWeatherData(lastSuccessfulWeatherData);
        }
        function updateUnitToggleUI() {
            unitToggleBtn.textContent = currentUnit === 'celsius' ? '°C' : '°F';
        }
        function getTemp(c, f) {
            if (currentUnit === 'fahrenheit') return f !== undefined ? `${Math.round(f)}°F` : 'N/A';
            return c !== undefined ? `${Math.round(c)}°C` : 'N/A';
        }

        // --- GEOLOCATION ---
        async function handleGeolocation() {
            if (!navigator.geolocation) {
                showTemporaryError("Geolocation not supported.", 3000); return;
            }
            geolocationBtn.disabled = true;
            geolocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finding...';
            clearSearchInputError();
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true, timeout: 20000, maximumAge: 0
                    });
                });
                locationInput.value = ''; // Clear search input
                fetchWeatherData(`${position.coords.latitude},${position.coords.longitude}`);
            } catch (error) {
                let msg = "Location error: ";
                switch (error.code) {
                    case error.PERMISSION_DENIED: msg += "Permission denied."; break;
                    case error.POSITION_UNAVAILABLE: msg += "Location unavailable."; break;
                    case error.TIMEOUT: msg += "Request timed out."; break;
                    default: msg += "Unknown error."; break;
                }
                showTemporaryError(msg, 4000);
                console.error("Geolocation Error:", error);
            } finally {
                geolocationBtn.disabled = false;
                geolocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use My Location';
            }
        }
        
        // --- UI UPDATES & ERROR DISPLAY ---
        function showTemporaryError(message, duration = 2000) {
            searchInputError.textContent = message;
            searchInputError.classList.add('visible');
            if (searchErrorTimeoutId) clearTimeout(searchErrorTimeoutId);
            searchErrorTimeoutId = setTimeout(() => searchInputError.classList.remove('visible'), duration);
        }

        function showCriticalError(message) {
            statusMessageContainer.innerHTML = `<p class="error-message">${message}</p>`;
            statusMessageContainer.style.display = 'block';
            weatherResultsArea.classList.remove('visible');
            lastSuccessfulWeatherData = null; // Critical error, clear last known good data
        }

        function showLoadingState(locationName, isPreservingContent = false) {
            statusMessageContainer.style.display = 'none';
            clearSearchInputError();
            locationHeaderElement.innerHTML = `<h2>Loading weather for ${locationName}...</h2>`;

            if (!isPreservingContent) {
                currentWeatherCard.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
                hourlyForecastContainer.innerHTML = '<div class="loader-container hourly-loader-placeholder"><div class="loader"></div></div>';
                forecastGrid.innerHTML = '<div class="loader-container"><div class="loader"></div></div>';
                if (!weatherResultsArea.classList.contains('visible')) {
                     requestAnimationFrame(() => setTimeout(() => weatherResultsArea.classList.add('visible'), 50));
                }
            } else { // Preserving content, just update header and hourly loader
                hourlyForecastContainer.innerHTML = '<div class="loader-container hourly-loader-placeholder"><div class="loader"></div></div>';
            }
        }
        
        // --- DATA DISPLAY ---
        function displayAllWeatherData(data) {
            displayCurrentWeather(data);
            displayHourlyForecast(data);
            display10DayForecast(data);
        }

        function displayCurrentWeather(data) {
            const { location, current } = data;
            if (!current || !current.condition) { currentWeatherCard.innerHTML = '<p>Current weather data unavailable.</p>'; return; }
            locationHeaderElement.innerHTML = `<h2>Weather in ${location.name}, ${location.country}</h2>`;
            let icon = current.condition.icon.startsWith('//') ? 'https:' + current.condition.icon : current.condition.icon;
            currentWeatherCard.innerHTML = `
                <div class="weather-icon-temp">
                    <img src="${icon}" alt="${current.condition.text}" class="current-icon">
                    <p class="current-temperature">${getTemp(current.temp_c, current.temp_f)}</p>
                    <p class="current-condition">${current.condition.text}</p>
                </div>
                <div class="current-details-grid">
                    <p><strong>Feels like:</strong> ${getTemp(current.feelslike_c, current.feelslike_f)}</p>
                    <p><strong>Humidity:</strong> ${current.humidity}%</p>
                    <p><strong>Wind:</strong> ${current.wind_kph} kph ${current.wind_dir}</p>
                    <p><strong>Pressure:</strong> ${current.pressure_mb} mb</p>
                    <p><strong>Visibility:</strong> ${current.vis_km} km</p><p><strong>UV Index:</strong> ${current.uv}</p>
                    <p><strong>Precipitation:</strong> ${current.precip_mm} mm</p>
                    <p><strong>Last Updated:</strong> ${current.last_updated.split(" ")[1]}</p> 
                </div>`;
            currentWeatherCard.classList.remove('content-visible'); // Reset for animation
            requestAnimationFrame(() => setTimeout(() => currentWeatherCard.classList.add('content-visible'), 50));
        }

        function displayHourlyForecast(data) {
            const hourlyData = data.forecast.forecastday[0].hour;
            hourlyForecastContainer.innerHTML = '';
            if (!hourlyData || hourlyData.length === 0) { hourlyForecastContainer.innerHTML = '<p>Hourly data not available.</p>'; return; }
            const now = new Date();
            const relevantHours = hourlyData.filter(h => new Date(h.time_epoch * 1000) >= now);
            
            if (relevantHours.length === 0) { hourlyForecastContainer.innerHTML = '<p>No more hourly data for today.</p>'; return; }

            relevantHours.slice(0, 24 - now.getHours() + 1).forEach((hour, index) => { // Show up to 24 hours from now or end of day
                 if (!hour.condition) return;
                let icon = hour.condition.icon.startsWith('//') ? 'https:' + hour.condition.icon : hour.condition.icon;
                const card = document.createElement('div'); card.className = 'hourly-card';
                card.innerHTML = `
                    <p class="time">${new Date(hour.time_epoch * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12:false })}</p>
                    <img src="${icon}" alt="${hour.condition.text}" class="condition-icon">
                    <p class="temp">${getTemp(hour.temp_c, hour.temp_f)}</p>
                    ${hour.chance_of_rain > 0 ? `<p class="chance-of-rain">${hour.chance_of_rain}% rain</p>` : ''}`;
                hourlyForecastContainer.appendChild(card);
                requestAnimationFrame(() => setTimeout(() => card.classList.add('visible'), index * 60));
            });
        }

        function display10DayForecast(data) {
            const forecastDays = data.forecast.forecastday;
            forecastGrid.innerHTML = '';
            forecastHeaderElement.textContent = `${FORECAST_DAYS}-Day Forecast`;
            if (!forecastDays || forecastDays.length === 0) { forecastGrid.innerHTML = '<p>10-day forecast not available.</p>'; return; }
            forecastDays.forEach((dayData, index) => {
                if (!dayData.day || !dayData.day.condition) return;
                let icon = dayData.day.condition.icon.startsWith('//') ? 'https:' + dayData.day.condition.icon : dayData.day.condition.icon;
                const card = document.createElement('div'); card.className = 'forecast-card';
                card.innerHTML = `
                    <p class="date">${new Date(dayData.date_epoch * 1000).toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short'})}</p>
                    <img src="${icon}" alt="${dayData.day.condition.text}" class="forecast-icon">
                    <p class="temperature">${getTemp(dayData.day.avgtemp_c, dayData.day.avgtemp_f)}</p>
                    <p class="condition">${dayData.day.condition.text}</p>
                    <p class="min-max">Min: ${getTemp(dayData.day.mintemp_c, dayData.day.mintemp_f)} / Max: ${getTemp(dayData.day.maxtemp_c, dayData.day.maxtemp_f)}</p>`;
                forecastGrid.appendChild(card);
                requestAnimationFrame(() => setTimeout(() => card.classList.add('visible'), index * 80));
            });
        }
        
        // --- SEARCH & FETCH ---
        function handleSearch() {
            const query = locationInput.value.trim();
            if (query) fetchWeatherData(query);
            else showTemporaryError("Please enter a city name.");
        }

        async function fetchWeatherData(locationQuery, isInitialLoad = false) {
            const preserveContent = !isInitialLoad && lastSuccessfulWeatherData && locationQuery.toLowerCase() !== lastSuccessfulWeatherData.location.name.toLowerCase();
            
            if (!isInitialLoad && weatherResultsArea.classList.contains('visible') && !preserveContent) {
                weatherResultsArea.classList.remove('visible');
                await new Promise(resolve => setTimeout(resolve, 300)); // Shorter out-transition
            }
            showLoadingState(isInitialLoad ? DEFAULT_LOCATION : locationQuery, preserveContent);

            const apiUrl = `https://api.weatherapi.com/v1/forecast.json?q=${encodeURIComponent(locationQuery)}&days=${FORECAST_DAYS}&key=${API_KEY}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.error) {
                    if (data.error.code === 1006) { // No location found
                        showTemporaryError(`No location found for "${locationQuery}". Please try again.`, 3000);
                        if (lastSuccessfulWeatherData && !isInitialLoad) { // Restore last good data if it was a user search
                            displayAllWeatherData(lastSuccessfulWeatherData);
                        } else if (isInitialLoad) { // Default location not found on first load
                            showCriticalError(`Could not load weather for default location: ${data.error.message}`);
                        } else { // No last good data, and search failed
                             locationHeaderElement.innerHTML = `<h2>Could not find "${locationQuery}"</h2>`;
                             currentWeatherCard.innerHTML = ''; hourlyForecastContainer.innerHTML = ''; forecastGrid.innerHTML = '';
                        }
                    } else { // Other API errors
                        throw new Error(data.error.message);
                    }
                    return; // Stop processing if API returned an error object
                }
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); // Network errors

                lastSuccessfulWeatherData = data; // Cache successful data
                displayAllWeatherData(data);
                
                if (!weatherResultsArea.classList.contains('visible')) {
                    requestAnimationFrame(() => setTimeout(() => weatherResultsArea.classList.add('visible'), 50));
                }
                if (!isInitialLoad && locationQuery.toLowerCase() !== DEFAULT_LOCATION.toLowerCase()) {
                     setTimeout(() => document.getElementById('weather-results-target')?.scrollIntoView({behavior: "smooth", block: "start"}), 200);
                }

            } catch (error) {
                console.error("Fetch Weather Error:", error);
                showCriticalError(`Failed to fetch weather: ${error.message}. Check console.`);
            }
        }
        
        // --- START APP ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>